<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Backroom Operations — Single-File App</title>
<style>
  :root{
    --bg:#0b1020; --panel:#111935; --panel-2:#162045; --ink:#eaf0ff; --muted:#b7c2e8; --line:#3a4a7a;
    --accent:#6aa6ff; --good:#63e27a; --warn:#ffd24a; --bad:#ff6b6b; --info:#7bd8ff;
  }
  html,body{height:100%;}
  body{margin:0;background:radial-gradient(1200px 1200px at 10% 0%,#131c3a 0%,var(--bg) 60%);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .app{max-width:1100px;margin:0 auto;padding:24px;}
  .topbar{display:flex;align-items:center;gap:14px;margin-bottom:16px}
  .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
  .logo svg{width:28px;height:28px}
  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto}
  .tab{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);padding:10px 14px;border-radius:12px;color:var(--ink);cursor:pointer;user-select:none}
  .tab.active{outline:2px solid var(--accent);}
  .panel{background:linear-gradient(180deg,var(--panel),rgba(22,32,69,.7));border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .row{display:flex;gap:10px;align-items:center}
  .spacer{flex:1}
  input[type="number"],input[type="text"],select{background:#0f1630;border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:10px;outline:none}
  button{background:linear-gradient(180deg,#1a2550,#14204a);border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  button:active{transform:translateY(1px)}
  .hint{color:var(--muted);font-size:12px}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0e183a;font-size:12px}
  .pill{padding:4px 10px;border-radius:999px;background:#0e183a;border:1px solid var(--line)}
  .section-title{display:flex;align-items:center;gap:10px;margin:8px 0 14px 0;font-weight:700}
  .section-title svg{width:20px;height:20px}

  .card{background:linear-gradient(180deg,#121d3f,#0d142e);border:1px solid var(--line);padding:12px;border-radius:14px;position:relative;overflow:hidden}
  .card .title{font-weight:700}
  .sub{font-size:12px;color:var(--muted)}
  .row.wrap{flex-wrap:wrap}

  /* Status colors & alerts */
  .status{font-weight:700}
  .s-working{color:var(--good)}
  .s-break{color:var(--info)}
  .s-lunch{color:var(--warn)}
  .s-overdue{color:var(--bad)}
  .blink{animation:blink 1s steps(2,end) infinite}
  @keyframes blink{50%{opacity:.35}}
  .card.overdue{border-color:var(--bad); box-shadow:0 0 0 0 rgba(255,107,107,.6); animation:pulseRed 1s infinite}
  @keyframes pulseRed{
    0%{box-shadow:0 0 0 0 rgba(255,107,107,.6)}
    70%{box-shadow:0 0 0 10px rgba(255,107,107,0)}
    100%{box-shadow:0 0 0 0 rgba(255,107,107,0)}
  }

  .ring{--size:54; --stroke:6; width:var(--size)px;height:var(--size)px}
  .ring svg{transform:rotate(-90deg)}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
  .modal .sheet{background:linear-gradient(180deg,#17224a,#11193a);border:1px solid var(--line);border-radius:16px;padding:16px;max-width:480px;width:100%}

  @media (max-width:900px){ .grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:640px){ .grid.cols-3,.grid.cols-2{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="logo" title="Backroom Operations">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18M5 7v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7" stroke="#7bd8ff" stroke-width="1.5"/><rect x="7" y="3" width="10" height="4" rx="1" stroke="#6aa6ff" stroke-width="1.5"/><path d="M9 11h6m-6 4h4" stroke="#9ad1ff" stroke-width="1.5"/></svg>
      <span>Backroom Ops</span>
      <span class="pill">Single-File</span>
    </div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="pallets">Pallet Tracking</div>
      <div class="tab" data-tab="staff">Staffing</div>
      <div class="tab" data-tab="audit">Audit Mode</div>
      <div class="tab" data-tab="reports">Reports</div>
    </div>
  </div>

  <!-- PALLETS -->
  <section class="panel" id="tab-pallets">
    <div class="section-title">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17h18M4 17l2-8h12l2 8" stroke="#7bd8ff" stroke-width="1.5"/><rect x="7" y="5" width="10" height="6" rx="1" stroke="#6aa6ff" stroke-width="1.5"/></svg>
      <span>Pallet Tracking</span>
      <span class="spacer"></span>
      <span class="hint">Type cycles: Standard → 2-Wave → 4-Wave</span>
    </div>
    <div class="row">
      <label class="hint">How many pallets?</label>
      <input id="palletCount" type="number" min="0" step="1" value="3" />
      <button id="setupPallets">Setup Pallets</button>
      <span class="spacer"></span>
      <button id="clearPallets" title="Remove saved pallets">Clear Saved</button>
    </div>
    <div id="palletGrid" class="grid cols-3" style="margin-top:12px"></div>
  </section>

  <!-- STAFFING -->
  <section class="panel" id="tab-staff" hidden>
    <div class="section-title">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="7" r="3" stroke="#7bd8ff" stroke-width="1.5"/><path d="M5 20c0-3.314 3.134-6 7-6s7 2.686 7 6" stroke="#6aa6ff" stroke-width="1.5"/></svg>
      <span>Staffing</span>
      <span class="spacer"></span>
      <span class="hint">Tap card or use buttons: Break (15m) / Lunch (45m)</span>
    </div>
    <div class="row">
      <button id="setupStaff">Setup 6 Employees</button>
      <button id="clearStaff">Clear Saved</button>
      <span class="spacer"></span>
      <span class="tag">Break overdue after <span id="breakLimitLabel">900</span>s</span>
      <span class="tag">Lunch overdue after <span id="lunchLimitLabel">2700</span>s</span>
    </div>
    <div id="staffGrid" class="grid cols-3" style="margin-top:12px"></div>
  </section>

  <!-- AUDIT -->
  <section class="panel" id="tab-audit" hidden>
    <div class="section-title">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="3" width="16" height="18" rx="2" stroke="#7bd8ff" stroke-width="1.5"/><path d="M8 7h8M8 11h8M8 15h6" stroke="#6aa6ff" stroke-width="1.5"/></svg>
      <span>Audit Mode</span>
      <span class="spacer"></span>
      <button id="undoAudit" title="Remove last audit entry">Undo last</button>
    </div>
    <div class="row wrap" style="gap:12px 12px">
      <label>Category</label>
      <select id="auditCat"></select>
      <label>Subcategory</label>
      <select id="auditSub"></select>
      <label>Count</label>
      <input id="auditCount" type="number" min="1" value="1" style="width:90px">
      <button id="auditRecord">Record</button>
      <span class="spacer"></span>
      <span class="hint">Every record is timestamped and saved locally.</span>
    </div>
    <div id="auditLog" style="margin-top:12px" class="grid"></div>
  </section>

  <!-- REPORTS -->
  <section class="panel" id="tab-reports" hidden>
    <div class="section-title">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 20V6a2 2 0 0 1 2-2h1v16H5Zm6 0V4h2a2 2 0 0 1 2 2v14h-4Zm8 0h-2V8h1a1 1 0 0 1 1 1v11Z" stroke="#7bd8ff" stroke-width="1.5"/></svg>
      <span>Reports</span>
      <span class="spacer"></span>
      <button id="exportBtn">Export JSON</button>
      <input id="importFile" type="file" accept="application/json" hidden />
      <button id="importBtn">Import JSON</button>
    </div>
    <div id="reportText" style="white-space:pre-wrap"></div>
  </section>
</div>

<!-- Modal: rename employee -->
<div class="modal" id="nameModal">
  <div class="sheet">
    <div class="section-title"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="7" r="3" stroke="#7bd8ff" stroke-width="1.5"/><path d="M5 20c0-3.314 3.134-6 7-6s7 2.686 7 6" stroke="#6aa6ff" stroke-width="1.5"/></svg><span>Rename Employee</span></div>
    <div class="row"><input type="text" id="nameInput" placeholder="e.g., Alex" class="spacer"></div>
    <div class="row" style="margin-top:12px"><span class="spacer"></span><button id="nameCancel">Cancel</button><button id="nameSave">Save</button></div>
  </div>
</div>

<script>
/********************\
* Tiny Local DB (LS) *
\********************/
const DB = {
  load(key, def){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); }catch{ return def } },
  save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
};

/****************
* Tab Switching *
*****************/
const tabsEl = document.getElementById('tabs');
const sections = {
  pallets: document.getElementById('tab-pallets'),
  staff: document.getElementById('tab-staff'),
  audit: document.getElementById('tab-audit'),
  reports: document.getElementById('tab-reports')
};
tabsEl.addEventListener('click', (e)=>{
  const t = e.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tab = t.dataset.tab;
  for(const [k,sec] of Object.entries(sections)) sec.hidden = (k!==tab);
  if(tab==='reports') renderReport();
});

/******************
* Helpers & Icons *
******************/
function el(html){ const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstChild; }
function fmtSecs(s){ const m=Math.floor(s/60), ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}` }
function ring(percent){
  const size=54, stroke=6, r=(size-stroke)/2, c=2*Math.PI*r, off=c*(1-percent);
  return `
  <div class="ring">
    <svg width="${size}" height="${size}">
      <circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="#223067" stroke-width="${stroke}" fill="none"/>
      <circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="#7bd8ff" stroke-width="${stroke}" stroke-linecap="round" fill="none" stroke-dasharray="${c}" stroke-dashoffset="${off}"/>
    </svg>
  </div>`;
}

/*******************
* Pallet Tracking  *
*******************/
const palletTypes = ["Standard","2-Wave","4-Wave"];
const palletDefaults = { type:"Standard", duration: 15*60, remaining: 15*60, cartons:0, status:"Not Started", startedAt:null, complete:false, overdue:false };
const palletGrid = document.getElementById('palletGrid');
const palletCount = document.getElementById('palletCount');
const setupPalletsBtn = document.getElementById('setupPallets');
const clearPalletsBtn = document.getElementById('clearPallets');

let pallets = DB.load('pallets', []);
let palletTimers = new Map();

function makePallet(i, data){
  const p = { ...structuredClone(palletDefaults), ...data };
  const id = i;
  const card = el(`<div class="card" data-id="${id}">
    <div class="row" style="align-items:flex-start;gap:10px">
      ${ring(1 - (p.remaining/p.duration))}
      <div class="spacer">
        <div class="title">Pallet #${id+1} <span class="sub">• <span class="ptype">${p.type}</span></span></div>
        <div class="sub">Time Left: <span class="tleft">${fmtSecs(p.remaining)}</span> · Cartons: <span class="cartons">${p.cartons}</span></div>
        <div class="sub">Status: <span class="status ${p.overdue? 's-overdue blink': p.complete? 's-working' : (p.status==='In Progress'?'s-working':'' )}">${p.overdue? 'Overdue': p.complete? 'Complete': p.status}</span></div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="startBtn">Start</button>
      <button class="cartonBtn">+1 Carton</button>
      <button class="typeBtn">Type</button>
      <span class="spacer"></span>
      <button class="completeBtn">Mark Complete</button>
    </div>
  </div>`);

  const tleft = card.querySelector('.tleft');
  const cartonsEl = card.querySelector('.cartons');
  const statusEl = card.querySelector('.status');
  const ptypeEl = card.querySelector('.ptype');
  const startBtn = card.querySelector('.startBtn');
  const cartonBtn = card.querySelector('.cartonBtn');
  const typeBtn = card.querySelector('.typeBtn');
  const completeBtn = card.querySelector('.completeBtn');

  function paint(){
    tleft.textContent = fmtSecs(p.remaining);
    cartonsEl.textContent = p.cartons;
    ptypeEl.textContent = p.type;
    statusEl.textContent = p.overdue? 'Overdue' : (p.complete? 'Complete' : p.status);
    statusEl.className = 'status ' + (p.overdue? 's-overdue blink' : p.complete? 's-working' : (p.status==='In Progress'?'s-working':'') );
    const pct = 1 - (p.remaining/p.duration);
    card.querySelector('.ring').outerHTML = ring(pct);
    card.classList.toggle('overdue', !!p.overdue);
  }
  function tick(){
    if(p.complete||p.overdue||p.status!=='In Progress') return;
    p.remaining = Math.max(0, p.remaining-1);
    if(p.remaining===0){ p.overdue = true; p.status = 'Overdue'; stopTimer(); }
    paint(); save();
  }
  function startTimer(){ stopTimer(); palletTimers.set(id, setInterval(tick, 1000)); }
  function stopTimer(){ const t=palletTimers.get(id); if(t){ clearInterval(t); palletTimers.delete(id);} }

  startBtn.addEventListener('click', ()=>{ if(p.status==='Not Started'){ p.status='In Progress'; p.startedAt=Date.now(); startTimer(); save(); paint(); }});
  cartonBtn.addEventListener('click', ()=>{ p.cartons++; paint(); save(); });
  typeBtn.addEventListener('click', ()=>{ const idx = palletTypes.indexOf(p.type); p.type = palletTypes[(idx+1)%palletTypes.length]; paint(); save(); });
  completeBtn.addEventListener('click', ()=>{ p.complete=true; p.status='Complete'; stopTimer(); paint(); save(); });

  function save(){ pallets[id]=p; DB.save('pallets', pallets);} 
  paint();
  return card;
}
function renderPallets(){
  palletGrid.innerHTML='';
  pallets.forEach((p,i)=> palletGrid.appendChild(makePallet(i,p)) );
}
setupPalletsBtn.addEventListener('click', ()=>{
  const n = Math.max(0, parseInt(palletCount.value||'0',10));
  pallets = Array.from({length:n}, (_,i)=> ({...structuredClone(palletDefaults), type: palletTypes[i%3]}));
  DB.save('pallets', pallets); renderPallets();
});
clearPalletsBtn.addEventListener('click', ()=>{ pallets=[]; DB.save('pallets', pallets); renderPallets(); });

/****************
* Staffing Grid *
*****************/
const staffGrid = document.getElementById('staffGrid');
const setupStaffBtn = document.getElementById('setupStaff');
const clearStaffBtn = document.getElementById('clearStaff');
const breakLimitSecs = 15*60; // 15 minutes
const lunchLimitSecs = 45*60; // 45 minutes
document.getElementById('breakLimitLabel').textContent = breakLimitSecs;
document.getElementById('lunchLimitLabel').textContent = lunchLimitSecs;

let staff = DB.load('staff', []);
let staffTimers = new Map();
let renameTargetIndex = null;

function makeStaff(i, data){
  const s = { name:`Employee ${i+1}`, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false, ...data };
  const card = el(`<div class="card" data-id="${i}">
    <div class="row" style="align-items:center;gap:10px">
      ${ring(0)}
      <div class="spacer">
        <div class="title"><span class="empName" style="cursor:text" title="Click to rename">${s.name}</span> <span class="sub">• <span class="status ${cls()}" title="Tap card to cycle status">${label()}</span></span></div>
        <div class="sub">Timer: <span class="timer">0:00</span></div>
      </div>
      <button class="resetBtn" title="Reset timers">Reset</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="breakBtn" title="Start a 15-minute break">Break 15</button>
      <button class="lunchBtn" title="Start a 45-minute lunch">Lunch 45</button>
      <button class="renameBtn">Rename</button>
      <span class="spacer"></span>
    </div>
  </div>`);
  const statusEl = card.querySelector('.status');
  const timerEl = card.querySelector('.timer');
  const nameEl = card.querySelector('.empName');
  const breakBtn = card.querySelector('.breakBtn');
  const lunchBtn = card.querySelector('.lunchBtn');
  const renameBtn = card.querySelector('.renameBtn');

  function cls(){ return s.overdue? 's-overdue blink' : s.status==='Working'? 's-working' : s.status==='Break'? 's-break' : 's-lunch'; }
  function label(){ return s.overdue? 'Overdue' : s.status; }

  function paint(){
    statusEl.className = 'status ' + cls();
    statusEl.textContent = label();
    const elapsed = s.status==='Break'? s.breakElapsed : s.status==='Lunch'? s.lunchElapsed : 0;
    timerEl.textContent = fmtSecs(elapsed);
    const lim = s.status==='Break'? breakLimitSecs : s.status==='Lunch'? lunchLimitSecs : 1;
    const pct = Math.min(1, elapsed/lim);
    card.querySelector('.ring').outerHTML = ring(pct);
    card.classList.toggle('overdue', !!s.overdue);
  }
  function save(){ staff[i]=s; DB.save('staff', staff); }
  function stop(){ const t=staffTimers.get(i); if(t){ clearInterval(t); staffTimers.delete(i);} }
  function start(){ stop(); staffTimers.set(i, setInterval(()=>{
    if(s.status==='Break'){ s.breakElapsed++; if(s.breakElapsed>breakLimitSecs){ s.overdue=true; }}
    else if(s.status==='Lunch'){ s.lunchElapsed++; if(s.lunchElapsed>lunchLimitSecs){ s.overdue=true; }}
    else { s.overdue=false; }
    paint(); save();
  },1000)); }

  card.addEventListener('click', (e)=>{
    if(e.target.closest('button')|| e.target===nameEl) return;
    if(s.status==='Working'){ s.status='Break'; s.overdue=false; start(); }
    else if(s.status==='Break'){ s.status='Lunch'; s.overdue=false; start(); }
    else { s.status='Working'; s.overdue=false; stop(); }
    paint(); save();
  });
  card.querySelector('.resetBtn').addEventListener('click', (e)=>{ e.stopPropagation(); s.breakElapsed=0; s.lunchElapsed=0; s.overdue=false; if(s.status!=='Working'){ /* keep timer running from zero */ } paint(); save(); });

  // Explicit controls
  breakBtn.addEventListener('click', (e)=>{ e.stopPropagation(); s.status='Break'; s.overdue=false; s.breakElapsed=0; start(); paint(); save(); });
  lunchBtn.addEventListener('click', (e)=>{ e.stopPropagation(); s.status='Lunch'; s.overdue=false; s.lunchElapsed=0; start(); paint(); save(); });
  renameBtn.addEventListener('click', (e)=>{ e.stopPropagation(); renameTargetIndex = i; openNameModal(s.name, (newName)=>{ s.name=newName||s.name; nameEl.textContent=s.name; paint(); save(); }); });
  nameEl.addEventListener('click', (e)=>{ e.stopPropagation(); renameTargetIndex = i; openNameModal(s.name, (newName)=>{ s.name=newName||s.name; nameEl.textContent=s.name; paint(); save(); }); });

  paint();
  return card;
}
function renderStaff(){
  staffGrid.innerHTML='';
  staff.forEach((s,i)=> staffGrid.appendChild(makeStaff(i,s)) );
}
setupStaffBtn.addEventListener('click', ()=>{
  staff = Array.from({length:6}, (_,i)=> ({ name:`Employee ${i+1}`, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false }));
  DB.save('staff', staff); renderStaff();
});
clearStaffBtn.addEventListener('click', ()=>{ staff=[]; DB.save('staff', staff); renderStaff(); });

/*************
* Name modal *
*************/
const nameModal = document.getElementById('nameModal');
const nameInput = document.getElementById('nameInput');
const nameCancel = document.getElementById('nameCancel');
const nameSave = document.getElementById('nameSave');
function openNameModal(curr, cb){
  nameInput.value=curr; nameModal.style.display='flex'; nameInput.focus();
  const onSave=()=>{ nameModal.style.display='none'; cb(nameInput.value.trim()); cleanup();};
  const onCancel=()=>{ nameModal.style.display='none'; cleanup();};
  function cleanup(){ nameSave.removeEventListener('click', onSave); nameCancel.removeEventListener('click', onCancel); document.removeEventListener('keydown', onKey); }
  function onKey(e){ if(e.key==='Enter') onSave(); if(e.key==='Escape') onCancel(); }
  nameSave.addEventListener('click', onSave); nameCancel.addEventListener('click', onCancel); document.addEventListener('keydown', onKey);
}

/************
* Audit Log *
************/
const auditCat = document.getElementById('auditCat');
const auditSub = document.getElementById('auditSub');
const auditCount = document.getElementById('auditCount');
const auditRecordBtn = document.getElementById('auditRecord');
const auditLog = document.getElementById('auditLog');
const undoAuditBtn = document.getElementById('undoAudit');

const defaultCats = {
  "Home":["Food","Décor","Kitchen","Miscellaneous"],
  "Assorted":["Mixed Home","Mixed Beauty","Random"],
  "Active":["Water Bottles","Weights","Miscellaneous"],
  "Shoes & Apparel":["GOH","Folded"],
  "Luggage":["Large","Small"],
  "Toys":["Large","Small"],
  "Miscellaneous":["Bed Pillows","Baskets","Yoga Mats"]
};

let audits = DB.load('audits', []);
function initAuditSelectors(){
  auditCat.innerHTML = Object.keys(defaultCats).map(k=>`<option>${k}</option>`).join('');
  fillSubs();
}
function fillSubs(){ const k=auditCat.value; auditSub.innerHTML = defaultCats[k].map(s=>`<option>${s}</option>`).join(''); }
auditCat.addEventListener('change', fillSubs);

auditRecordBtn.addEventListener('click', ()=>{
  const entry = { pallet_id: 1, category: auditCat.value, subcategory: auditSub.value, count: parseInt(auditCount.value||'1',10), timestamp: new Date().toISOString() };
  audits.push(entry); DB.save('audits', audits); renderAudit();
});
undoAuditBtn.addEventListener('click', ()=>{ audits.pop(); DB.save('audits', audits); renderAudit(); });

function renderAudit(){
  auditLog.innerHTML = '';
  if(audits.length===0){ auditLog.appendChild(el(`<div class="hint">No audit records yet.</div>`)); return; }
  const byTime = [...audits].reverse();
  byTime.forEach((a)=>{ auditLog.appendChild(el(`<div class="card"><div class="row"><div class="title">${a.category} • ${a.subcategory}</div><span class="spacer"></span><span class="pill">x${a.count}</span></div><div class="sub">${new Date(a.timestamp).toLocaleString()}</div></div>`)); });
}

/***********
* Reports  *
***********/
const reportText = document.getElementById('reportText');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');

function renderReport(){
  const pallets = DB.load('pallets', []);
  const audits = DB.load('audits', []);
  const staff = DB.load('staff', []);
  const rpt = [
    `Report generated on ${new Date().toISOString()}`,
    `Total Pallets: ${pallets.length}`,
    `Total Audits: ${audits.length}`,
    `Total Staff Entries: ${staff.length}`,
    '',
    '— Pallets —',
    ...pallets.map((p,i)=>`#${i+1} ${p.type} • ${p.status}${p.overdue?' (Overdue)':''} • Cartons ${p.cartons} • Remaining ${fmtSecs(p.remaining)}`),
    '',
    '— Recent Audits (up to 10) —',
    ...audits.slice(-10).map(a=>`${new Date(a.timestamp).toLocaleString()} — ${a.category} / ${a.subcategory} x${a.count}`),
    '',
    '— Staff —',
    ...staff.map(s=>`${s.name} — ${s.status}${s.overdue?' (Overdue)':''} ${s.status==='Break'? '(Break '+fmtSecs(s.breakElapsed)+')' : s.status==='Lunch'? '(Lunch '+fmtSecs(s.lunchElapsed)+')' : ''}`)
  ].join('\n');
  reportText.textContent = rpt;
}
exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([ JSON.stringify({ pallets:DB.load('pallets',[]), audits:DB.load('audits',[]), staff:DB.load('staff',[]) }, null, 2) ], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='backroom-data.json'; a.click(); URL.revokeObjectURL(url);
});
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', ()=>{
  const f = importFile.files[0]; if(!f) return; const rd = new FileReader(); rd.onload = ()=>{
    try{ const obj = JSON.parse(rd.result);
      if(obj.pallets) DB.save('pallets', obj.pallets);
      if(obj.audits) DB.save('audits', obj.audits);
      if(obj.staff) DB.save('staff', obj.staff);
      pallets = DB.load('pallets', []); staff = DB.load('staff', []); audits = DB.load('audits', []);
      renderPallets(); renderStaff(); renderAudit(); renderReport();
    }catch(e){ alert('Invalid file.'); }
  }; rd.readAsText(f);
});

/****************
* Boot / Resume *
****************/
function boot(){
  if(pallets.length===0){ pallets = Array.from({length:3}, (_,i)=> ({...structuredClone(palletDefaults), type: palletTypes[i%3]})); DB.save('pallets', pallets); }
  renderPallets();
  if(staff.length===0){ staff = Array.from({length:6}, (_,i)=> ({ name:`Employee ${i+1}`, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false })); DB.save('staff', staff); }
  renderStaff();
  initAuditSelectors(); renderAudit();
}
boot();
</script>
</body>
</html>
