<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Backroom Ops — Mobile</title>
<style>
  :root{
    --bg:#0b1020; --panel:#111935; --panel-2:#162045; --ink:#eaf0ff; --muted:#b7c2e8; --line:#3a4a7a;
    --accent:#6aa6ff; --good:#63e27a; --warn:#ffd24a; --bad:#ff6b6b; --info:#7bd8ff;
    --role-unload:#15c0b0; --role-sort:#4ea2ff; --role-hang:#b266ff; --role-proc:#ffcc55;
  }
  html,body{height:100%;}
  body{margin:0;background:radial-gradient(1200px 1200px at 10% 0%,#131c3a 0%,var(--bg) 60%);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .app{max-width:900px;margin:0 auto;padding:12px;}
  .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .logo{display:flex;align-items:center;gap:8px;font-weight:800;letter-spacing:.3px}
  .logo svg{width:24px;height:24px}
  .tabs{display:flex;gap:6px;margin-left:auto}
  .tab{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);padding:8px 10px;border-radius:10px;color:var(--ink);cursor:pointer}
  .tab.active{outline:2px solid var(--accent);}
  .panel{background:linear-gradient(180deg,var(--panel),rgba(22,32,69,.7));border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .grid{display:grid;gap:10px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  input,select,button{font-size:15px}
  input[type="number"],input[type="text"],select{background:#0f1630;border:1px solid var(--line);color:var(--ink);padding:10px 10px;border-radius:10px;outline:none;min-height:40px}
  button{background:linear-gradient(180deg,#1a2550,#14204a);border:1px solid var(--line);color:var(--ink);padding:10px;border-radius:12px;cursor:pointer;min-height:40px}
  button:hover{filter:brightness(1.05)}
  .hint{color:var(--muted);font-size:12px}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0e183a;font-size:12px}
  .pill{padding:4px 10px;border-radius:999px;background:#0e183a;border:1px solid var(--line)}
  .section-title{display:flex;align-items:center;gap:8px;margin:4px 0 10px 0;font-weight:700}
  .section-title svg{width:18px;height:18px}

  .card{background:linear-gradient(180deg,#121d3f,#0d142e);border:1px solid var(--line);padding:10px;border-radius:14px;position:relative;overflow:hidden}
  .card .title{font-weight:700}
  .sub{font-size:12px;color:var(--muted)}
  .role-badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line)}
  .role-unload{background:rgba(21,192,176,.18);color:#a6fff6}
  .role-sort{background:rgba(78,162,255,.18);color:#cfe4ff}
  .role-hang{background:rgba(178,102,255,.18);color:#eed9ff}
  .role-proc{background:rgba(255,204,85,.18);color:#fff2cc}
  .role-emoji{font-size:14px}

  .status{font-weight:700}
  .s-working{color:var(--good)}
  .s-break{color:var(--info)}
  .s-lunch{color:var(--warn)}
  .s-overdue{color:var(--bad)}
  .blink{animation:blink 1s steps(2,end) infinite}
  @keyframes blink{50%{opacity:.35}}
  .card.overdue{border-color:var(--bad); box-shadow:0 0 0 0 rgba(255,107,107,.6); animation:pulseRed 1s infinite}
  @keyframes pulseRed{0%{box-shadow:0 0 0 0 rgba(255,107,107,.6)} 70%{box-shadow:0 0 0 10px rgba(255,107,107,0)} 100%{box-shadow:0 0 0 0 rgba(255,107,107,0)}}

  .ring{--size:50; --stroke:6; width:var(--size)px;height:var(--size)px}
  .ring svg{transform:rotate(-90deg)}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
  .modal .sheet{background:linear-gradient(180deg,#17224a,#11193a);border:1px solid var(--line);border-radius:16px;padding:16px;max-width:420px;width:100%}

  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .controls > *{flex:1 1 130px}
  .thin{min-width:0}

  .compact .card{padding:8px}
  .compact .ring{--size:40; --stroke:5}
  .compact .title{font-size:14px}
  .compact .sub{font-size:11px}

  @media (max-width:900px){ .grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:640px){ .grid.cols-3,.grid.cols-2{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="logo" title="Backroom Ops">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18M5 7v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7" stroke="#7bd8ff" stroke-width="1.5"/><rect x="7" y="3" width="10" height="4" rx="1" stroke="#6aa6ff" stroke-width="1.5"/><path d="M9 11h6m-6 4h4" stroke="#9ad1ff" stroke-width="1.5"/></svg>
      <span>Backroom Ops</span>
      <span class="pill">Mobile</span>
    </div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="pallets">Pallets</div>
      <div class="tab" data-tab="staff">Staffing</div>
      <div class="tab" data-tab="audit">Audit</div>
      <div class="tab" data-tab="reports">Reports</div>
    </div>
  </div>

  <!-- PALLETS -->
  <section class="panel" id="tab-pallets">
    <div class="section-title">
      <span>Pallet Tracking</span>
      <span class="spacer"></span>
      <span class="hint">Type cycles: Standard → 2-Wave → 4-Wave</span>
    </div>
    <div class="row">
      <label class="hint">How many pallets?</label>
      <input id="palletCount" type="number" min="0" max="12" step="1" value="3" />
      <button id="setupPallets">Setup</button>
      <button id="clearPallets" title="Remove saved pallets">Clear</button>
    </div>
    <div id="palletGrid" class="grid cols-3" style="margin-top:10px"></div>

    <div class="row" style="margin-top:8px">
      <div class="tag">Pallet chime: separate sound • Mute/Volume in Staffing</div>
    </div>
  </section>

  <!-- STAFFING -->
  <section class="panel" id="tab-staff" hidden>
    <div class="section-title">
      <span>Staffing</span>
      <span class="spacer"></span>
      <label class="row" style="gap:6px">
        <input type="checkbox" id="compactToggle"/> <span class="hint">Compact mode</span>
      </label>
    </div>

    <!-- Quick controls -->
    <div class="controls" style="margin-bottom:8px">
      <div class="row thin">
        <label class="hint">Employees (1–10)</label>
        <input id="empCount" type="number" min="1" max="10" value="6" class="thin"/>
        <button id="addEmp">Add</button>
        <button id="removeEmp">Remove</button>
      </div>
      <div class="row thin">
        <select id="presetSelect" class="spacer">
          <option>Alex</option><option>Danny</option><option>Riley-L</option><option>Jada</option>
          <option>Jaden</option><option>Aiden</option><option>Hannah</option><option>Zena</option>
          <option>April</option><option>Carrissa (OTN)</option><option>Ok</option>
        </select>
        <button id="applyPreset">Name next</button>
      </div>
      <div class="row thin">
        <label class="hint">Role filter</label>
        <select id="filterRole" class="spacer">
          <option value="">All roles</option>
          <option>Unloading</option><option>Sorting</option><option>Hanging</option><option>Processing</option>
        </select>
      </div>
      <div class="row thin">
        <label class="hint">Sub-task</label>
        <select id="filterSub" class="spacer">
          <option value="">All sub-tasks</option>
          <option>Shoes</option><option>Luggage</option><option>Purses</option><option>Furniture</option>
        </select>
      </div>
    </div>

    <!-- Alerts & audio -->
    <div class="panel" style="margin:8px 0">
      <div class="row">
        <strong>Alerts & Chimes</strong><span class="spacer"></span>
        <button id="notifBtn">Enable desktop notifications</button>
      </div>
      <div class="row">
        <label class="row" style="gap:6px"><input type="checkbox" id="muteToggle"> Mute</label>
        <label>Volume <input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.8"></label>
        <button id="testBreak">Test Break Chime</button>
        <button id="testPallet">Test Pallet Chime</button>
      </div>
      <div class="row">
        <span class="tag">Break 15m • Lunch 45m</span>
        <span class="tag">Escalation: 5m pulse • 10m double-chime</span>
      </div>
    </div>

    <div id="staffGrid" class="grid cols-2" style="margin-top:8px"></div>
  </section>

  <!-- AUDIT -->
  <section class="panel" id="tab-audit" hidden>
    <div class="section-title"><span>Audit Mode</span><span class="spacer"></span><button id="undoAudit" title="Remove last audit entry">Undo last</button></div>
    <div class="row">
      <label>Category</label><select id="auditCat"></select>
      <label>Subcategory</label><select id="auditSub"></select>
      <label>Count</label><input id="auditCount" type="number" min="1" value="1" style="width:90px">
      <button id="auditRecord">Record</button><span class="spacer"></span><span class="hint">Saved locally</span>
    </div>
    <div id="auditLog" style="margin-top:10px" class="grid"></div>
  </section>

  <!-- REPORTS -->
  <section class="panel" id="tab-reports" hidden>
    <div class="section-title"><span>Reports</span><span class="spacer"></span><button id="exportBtn">Export JSON</button><input id="importFile" type="file" accept="application/json" hidden /><button id="importBtn">Import JSON</button></div>
    <div id="reportText" style="white-space:pre-wrap"></div>
  </section>
</div>

<!-- Modal: rename employee -->
<div class="modal" id="nameModal">
  <div class="sheet">
    <div class="section-title"><span>Rename Employee</span></div>
    <div class="row"><input type="text" id="nameInput" placeholder="e.g., Alex" class="spacer"></div>
    <div class="row" style="margin-top:12px"><span class="spacer"></span><button id="nameCancel">Cancel</button><button id="nameSave">Save</button></div>
  </div>
</div>

<script>
/*************** Local DB ***************/
const DB = {
  load(key, def){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); }catch{ return def } },
  save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
};

/*************** Tabs ***************/
const sections = {
  pallets: document.getElementById('tab-pallets'),
  staff: document.getElementById('tab-staff'),
  audit: document.getElementById('tab-audit'),
  reports: document.getElementById('tab-reports')
};
document.getElementById('tabs').addEventListener('click', (e)=>{
  const t = e.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tab = t.dataset.tab;
  for(const [k,sec] of Object.entries(sections)) sec.hidden = (k!==tab);
  if(tab==='reports') renderReport();
});

/*************** Helpers ***************/
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
function fmtSecs(s){ const m=Math.floor(s/60), ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}` }
function ring(percent){
  const size=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ring-size')||'50')||50;
  const stroke=6, r=(size-stroke)/2, c=2*Math.PI*r, off=c*(1-Math.max(0,Math.min(1,percent)));
  return `<div class="ring"><svg width="${size}" height="${size}"><circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="#223067" stroke-width="${stroke}" fill="none"/><circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="#7bd8ff" stroke-width="${stroke}" stroke-linecap="round" fill="none" stroke-dasharray="${c}" stroke-dashoffset="${off}"/></svg></div>`;
}
const ROLE_ICON = { Unloading:'📦', Sorting:'🔀', Hanging:'👗', Processing:'🛠️' };
const ROLE_BADGE = { Unloading:'role-unload', Sorting:'role-sort', Hanging:'role-hang', Processing:'role-proc' };

/*************** Web Audio (chimes) ***************/
const AudioBus = (()=> {
  let ctx, gain;
  function ensure(){
    if(!ctx){ ctx = new (window.AudioContext||window.webkitAudioContext)(); gain = ctx.createGain(); gain.gain.value = Number(DB.load('vol','0.8')); gain.connect(ctx.destination); }
  }
  function setVolume(v){ ensure(); gain.gain.value=v; DB.save('vol', String(v)); }
  function beep(seq){ // seq: [{f,d}] in Hz & seconds
    ensure(); if(DB.load('mute', false)) return;
    let t = ctx.currentTime;
    seq.forEach(({f=880,d=0.15})=>{
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(gain);
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(0.9, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+d);
      o.start(t); o.stop(t+d+0.02);
      t += d + 0.05;
    });
  }
  function chimeBreak(escalated=false){ // single vs double
    const base = [{f:988,d:0.12},{f:1319,d:0.12}];
    beep(escalated? base.concat(base) : base);
  }
  function chimePallet(escalated=false){
    const base = [{f:660,d:0.12},{f:880,d:0.12}];
    beep(escalated? base.concat(base) : base);
  }
  function resume(){ ensure(); ctx.resume?.(); }
  return { setVolume, chimeBreak, chimePallet, resume };
})();

/*************** Notifications ***************/
async function notify(title, body){
  try{
    if(Notification.permission==='default'){ await Notification.requestPermission(); }
    if(Notification.permission==='granted'){ new Notification(title, { body }); }
  }catch{}
}

/*************** Pallets ***************/
const palletTypes = ["Standard","2-Wave","4-Wave"];
const palletDefaults = { type:"Standard", duration: 15*60, remaining: 15*60, cartons:0, status:"Not Started", startedAt:null, complete:false, overdue:false, overdueSince:null };
const palletGrid = document.getElementById('palletGrid');
let pallets = DB.load('pallets', []);
let palletTimers = new Map();

function makePallet(i, data){
  const p = { ...structuredClone(palletDefaults), ...data };
  const id = i;
  const card = el(`<div class="card" data-id="${id}">
    <div class="row" style="align-items:flex-start;gap:10px">
      ${ring(1 - (p.remaining/p.duration))}
      <div class="spacer">
        <div class="title">Pallet #${id+1} <span class="sub">• <span class="ptype">${p.type}</span></span></div>
        <div class="sub">Time Left: <span class="tleft">${fmtSecs(p.remaining)}</span> · Cartons: <span class="cartons">${p.cartons}</span></div>
        <div class="sub">Status: <span class="status ${p.overdue? 's-overdue blink': p.complete? 's-working' : (p.status==='In Progress'?'s-working':'' )}">${p.overdue? 'Overdue': p.complete? 'Complete': p.status}</span></div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="startBtn">Start</button>
      <button class="cartonBtn">+1</button>
      <button class="typeBtn">Type</button>
      <span class="spacer"></span>
      <button class="completeBtn">Complete</button>
    </div>
  </div>`);
  const tleft = card.querySelector('.tleft');
  const cartonsEl = card.querySelector('.cartons');
  const statusEl = card.querySelector('.status');
  const ptypeEl = card.querySelector('.ptype');

  function paint(){
    tleft.textContent = fmtSecs(p.remaining);
    cartonsEl.textContent = p.cartons;
    ptypeEl.textContent = p.type;
    statusEl.textContent = p.overdue? 'Overdue' : (p.complete? 'Complete' : p.status);
    statusEl.className = 'status ' + (p.overdue? 's-overdue blink' : p.complete? 's-working' : (p.status==='In Progress'?'s-working':'') );
    const pct = 1 - (p.remaining/p.duration);
    card.querySelector('.ring').outerHTML = ring(pct);
    card.classList.toggle('overdue', !!p.overdue);
  }
  function tick(){
    if(p.complete||p.status!=='In Progress') return;
    if(p.remaining>0){ p.remaining = Math.max(0, p.remaining-1); }
    if(p.remaining===0 && !p.overdue){
      p.overdue = true; p.overdueSince = Date.now();
      AudioBus.chimePallet(false); notify('Pallet overdue', `Pallet #${id+1} is overdue`);
    } else if(p.overdue){
      const overSec = Math.floor((Date.now()-p.overdueSince)/1000);
      if(overSec===300){ /* 5m */ /* visual already pulses via CSS */ }
      if(overSec!==0 && overSec%120===0){ AudioBus.chimePallet(false); } // repeat every 2m
      if(overSec===600){ AudioBus.chimePallet(true); } // 10m double
    }
    paint(); save();
  }
  function startTimer(){ stopTimer(); palletTimers.set(id, setInterval(tick, 1000)); }
  function stopTimer(){ const t=palletTimers.get(id); if(t){ clearInterval(t); palletTimers.delete(id);} }

  card.querySelector('.startBtn').addEventListener('click', ()=>{ if(p.status==='Not Started'){ p.status='In Progress'; p.startedAt=Date.now(); startTimer(); save(); paint(); }});
  card.querySelector('.cartonBtn').addEventListener('click', ()=>{ p.cartons++; paint(); save(); });
  card.querySelector('.typeBtn').addEventListener('click', ()=>{ const idx = palletTypes.indexOf(p.type); p.type = palletTypes[(idx+1)%palletTypes.length]; paint(); save(); });
  card.querySelector('.completeBtn').addEventListener('click', ()=>{ p.complete=true; p.status='Complete'; p.overdue=false; stopTimer(); paint(); save(); });

  function save(){ pallets[id]=p; DB.save('pallets', pallets);} 
  paint();
  return card;
}
function renderPallets(){ palletGrid.innerHTML=''; pallets.forEach((p,i)=> palletGrid.appendChild(makePallet(i,p)) ); }
document.getElementById('setupPallets').addEventListener('click', ()=>{
  const n = Math.max(0, parseInt(document.getElementById('palletCount').value||'0',10));
  pallets = Array.from({length:n}, (_,i)=> ({...structuredClone(palletDefaults), type: palletTypes[i%3]}));
  DB.save('pallets', pallets); renderPallets();
});
document.getElementById('clearPallets').addEventListener('click', ()=>{ pallets=[]; DB.save('pallets', pallets); renderPallets(); });

/*************** Staffing ***************/
const staffGrid = document.getElementById('staffGrid');
const breakLimitSecs = 15*60; // 15m
const lunchLimitSecs = 45*60; // 45m
const PRESETS = ["Alex","Danny","Riley-L","Jada","Jaden","Aiden","Hannah","Zena","April","Carrissa (OTN)","Ok"];
let staff = DB.load('staff', []); // each: { name, status, breakElapsed, lunchElapsed, overdue, role, sub, overdueSince }
let staffTimers = new Map();

function roleEmoji(role){ return ROLE_ICON[role]||'•'; }
function roleBadge(role){ return ROLE_BADGE[role]||''; }

function makeStaff(i, data){
  const s = { name:`Employee ${i+1}`, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false, overdueSince:null, role:'Unloading', sub:'', ...data };
  const card = el(`<div class="card" data-id="${i}">
    <div class="row" style="align-items:center;gap:8px">
      ${ring(0)}
      <div class="spacer">
        <div class="title">
          <span class="empName" style="cursor:text">${s.name}</span>
          <span class="sub">• <span class="status ${cls()}">${label()}</span></span>
        </div>
        <div class="sub">Timer: <span class="timer">0:00</span></div>
        <div class="row" style="margin-top:4px">
          <span class="role-badge ${roleBadge(s.role)}"><span class="role-emoji">${roleEmoji(s.role)}</span> <span class="roleText">${s.role}</span></span>
          <span class="pill subPill" ${s.role==='Processing' && s.sub ? '' : 'style="display:none"'}>${s.sub||''}</span>
        </div>
      </div>
      <button class="resetBtn" title="Reset timers">Reset</button>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="breakBtn" title="Start a 15-minute break">Break 15</button>
      <button class="lunchBtn" title="Start a 45-minute lunch">Lunch 45</button>
      <button class="renameBtn">Rename</button>
      <span class="spacer"></span>
      <select class="roleSel">
        <option>Unloading</option><option>Sorting</option><option>Hanging</option><option>Processing</option>
      </select>
      <select class="subSel" ${s.role==='Processing'?'':'style="display:none"'} >
        <option value="">— Sub-task —</option><option>Shoes</option><option>Luggage</option><option>Purses</option><option>Furniture</option>
      </select>
    </div>
  </div>`);

  const statusEl = card.querySelector('.status');
  const timerEl = card.querySelector('.timer');
  const nameEl = card.querySelector('.empName');
  const breakBtn = card.querySelector('.breakBtn');
  const lunchBtn = card.querySelector('.lunchBtn');
  const renameBtn = card.querySelector('.renameBtn');
  const resetBtn = card.querySelector('.resetBtn');
  const roleSel = card.querySelector('.roleSel');
  const subSel = card.querySelector('.subSel');
  const roleText = card.querySelector('.roleText');
  const subPill = card.querySelector('.subPill');

  roleSel.value = s.role;
  subSel.value = s.sub || "";

  function cls(){ return s.overdue? 's-overdue blink' : s.status==='Working'? 's-working' : s.status==='Break'? 's-break' : 's-lunch'; }
  function label(){ return s.overdue? 'Overdue' : s.status; }

  function paint(){
    statusEl.className = 'status ' + cls();
    statusEl.textContent = label();
    const elapsed = s.status==='Break'? s.breakElapsed : s.status==='Lunch'? s.lunchElapsed : 0;
    timerEl.textContent = fmtSecs(elapsed);
    const lim = s.status==='Break'? breakLimitSecs : s.status==='Lunch'? lunchLimitSecs : 1;
    const pct = Math.min(1, elapsed/lim);
    card.querySelector('.ring').outerHTML = ring(pct);
    card.classList.toggle('overdue', !!s.overdue);
    // role & sub
    roleText.textContent = s.role;
    card.querySelector('.role-badge').className = 'role-badge ' + roleBadge(s.role);
    card.querySelector('.role-emoji').textContent = roleEmoji(s.role);
    subPill.textContent = s.sub||'';
    subPill.style.display = (s.role==='Processing' && s.sub)? '' : 'none';
  }

  function save(){ staff[i]=s; DB.save('staff', staff); }

  function stop(){ const t=staffTimers.get(i); if(t){ clearInterval(t); staffTimers.delete(i);} }
  function start(){ stop(); staffTimers.set(i, setInterval(()=>{
    if(s.status==='Break'){ s.breakElapsed++; if(s.breakElapsed>breakLimitSecs){ onOverdue(); }}
    else if(s.status==='Lunch'){ s.lunchElapsed++; if(s.lunchElapsed>lunchLimitSecs){ onOverdue(); }}
    else { s.overdue=false; s.overdueSince=null; }
    // escalation + repeats
    if(s.overdue && s.overdueSince){
      const overSec = Math.floor((Date.now()-s.overdueSince)/1000);
      if(overSec!==0 && overSec%120===0){ AudioBus.chimeBreak(false); } // repeat every 2m
      if(overSec===600){ AudioBus.chimeBreak(true); } // 10m double
    }
    paint(); save();
  },1000)); }

  function onOverdue(){
    if(!s.overdue){ s.overdue=true; s.overdueSince=Date.now(); AudioBus.chimeBreak(false); notify('Break/Lunch overdue', `${s.name} • ${s.status}`); }
  }

  // Tap card cycles
  card.addEventListener('click', (e)=>{
    if(e.target.closest('button')|| e.target.closest('select')|| e.target===nameEl) return;
    if(s.status==='Working'){ s.status='Break'; s.overdue=false; s.overdueSince=null; start(); }
    else if(s.status==='Break'){ s.status='Lunch'; s.overdue=false; s.overdueSince=null; start(); }
    else { s.status='Working'; s.overdue=false; s.overdueSince=null; stop(); }
    paint(); save();
  });

  // Buttons
  resetBtn.addEventListener('click', (e)=>{ e.stopPropagation(); s.breakElapsed=0; s.lunchElapsed=0; s.overdue=false; s.overdueSince=null; if(s.status!=='Working'){ /* keep running */ } paint(); save(); });
  breakBtn.addEventListener('click', (e)=>{ e.stopPropagation(); s.status='Break'; s.overdue=false; s.overdueSince=null; s.breakElapsed=0; start(); paint(); save(); });
  lunchBtn.addEventListener('click', (e)=>{ e.stopPropagation(); s.status='Lunch'; s.overdue=false; s.overdueSince=null; s.lunchElapsed=0; start(); paint(); save(); });
  renameBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openNameModal(s.name, (newName)=>{ s.name=newName||s.name; nameEl.textContent=s.name; paint(); save(); }); });

  roleSel.addEventListener('change', (e)=>{ s.role = roleSel.value; if(s.role!=='Processing'){ s.sub=''; subSel.value=""; } subSel.style.display = s.role==='Processing' ? '' : 'none'; paint(); save(); });
  subSel.addEventListener('change', (e)=>{ s.sub = subSel.value || ''; paint(); save(); });

  paint();
  return card;
}

function renderStaff(){
  staffGrid.innerHTML='';
  const r = document.getElementById('filterRole').value;
  const sub = document.getElementById('filterSub').value;
  staff.forEach((s,i)=>{
    if(r && s.role!==r) return;
    if(sub && s.sub!==sub) return;
    staffGrid.appendChild(makeStaff(i,s));
  });
}

function setStaffCount(n){
  n = Math.max(1, Math.min(10, n));
  const curr = staff.length;
  if(n>curr){
    const start = curr;
    for(let k=0;k<n-curr;k++){
      const name = PRESETS[(start+k)%PRESETS.length] || `Employee ${start+k+1}`;
      staff.push({ name, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false, overdueSince:null, role:'Unloading', sub:'' });
    }
  }else if(n<curr){
    staff.length = n;
  }
  DB.save('staff', staff);
  renderStaff();
}

/*************** Name modal ***************/
const nameModal = document.getElementById('nameModal');
const nameInput = document.getElementById('nameInput');
const nameCancel = document.getElementById('nameCancel');
const nameSave = document.getElementById('nameSave');
function openNameModal(curr, cb){
  nameInput.value=curr; nameModal.style.display='flex'; nameInput.focus();
  const onSave=()=>{ nameModal.style.display='none'; cleanup(); cb(nameInput.value.trim()); };
  const onCancel=()=>{ nameModal.style.display='none'; cleanup(); };
  function onKey(e){ if(e.key==='Enter') onSave(); if(e.key==='Escape') onCancel(); }
  function cleanup(){ nameSave.removeEventListener('click', onSave); nameCancel.removeEventListener('click', onCancel); document.removeEventListener('keydown', onKey); }
  nameSave.addEventListener('click', onSave); nameCancel.addEventListener('click', onCancel); document.addEventListener('keydown', onKey);
}

/*************** Audit ***************/
const auditCat = document.getElementById('auditCat');
const auditSub = document.getElementById('auditSub');
const auditCount = document.getElementById('auditCount');
const auditRecordBtn = document.getElementById('auditRecord');
const auditLog = document.getElementById('auditLog');
const undoAuditBtn = document.getElementById('undoAudit');
const defaultCats = {
  "Home":["Food","Décor","Kitchen","Miscellaneous"],
  "Assorted":["Mixed Home","Mixed Beauty","Random"],
  "Active":["Water Bottles","Weights","Miscellaneous"],
  "Shoes & Apparel":["GOH","Folded"],
  "Luggage":["Large","Small"],
  "Toys":["Large","Small"],
  "Miscellaneous":["Bed Pillows","Baskets","Yoga Mats"]
};
let audits = DB.load('audits', []);
function initAuditSelectors(){ auditCat.innerHTML = Object.keys(defaultCats).map(k=>`<option>${k}</option>`).join(''); fillSubs(); }
function fillSubs(){ const k=auditCat.value; auditSub.innerHTML = defaultCats[k].map(s=>`<option>${s}</option>`).join(''); }
auditCat.addEventListener('change', fillSubs);
auditRecordBtn.addEventListener('click', ()=>{ const entry = { pallet_id: 1, category: auditCat.value, subcategory: auditSub.value, count: parseInt(auditCount.value||'1',10), timestamp: new Date().toISOString() }; audits.push(entry); DB.save('audits', audits); renderAudit(); });
undoAuditBtn.addEventListener('click', ()=>{ audits.pop(); DB.save('audits', audits); renderAudit(); });
function renderAudit(){ auditLog.innerHTML = ''; if(audits.length===0){ auditLog.appendChild(el(`<div class="hint">No audit records yet.</div>`)); return; } [...audits].reverse().forEach((a)=>{ auditLog.appendChild(el(`<div class="card"><div class="row"><div class="title">${a.category} • ${a.subcategory}</div><span class="spacer"></span><span class="pill">x${a.count}</span></div><div class="sub">${new Date(a.timestamp).toLocaleString()}</div></div>`)); }); }

/*************** Reports ***************/
const reportText = document.getElementById('reportText');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
function renderReport(){
  const pallets = DB.load('pallets', []);
  const audits = DB.load('audits', []);
  const staff = DB.load('staff', []);
  const rpt = [
    `Report generated on ${new Date().toISOString()}`,
    `Total Pallets: ${pallets.length}`,
    `Total Audits: ${audits.length}`,
    `Total Staff Entries: ${staff.length}`,
    '',
    '— Pallets —',
    ...pallets.map((p,i)=>`#${i+1} ${p.type} • ${p.status}${p.overdue?' (Overdue)':''} • Cartons ${p.cartons} • Remaining ${fmtSecs(p.remaining)}`),
    '',
    '— Recent Audits (up to 10) —',
    ...audits.slice(-10).map(a=>`${new Date(a.timestamp).toLocaleString()} — ${a.category} / ${a.subcategory} x${a.count}`),
    '',
    '— Staff —',
    ...staff.map(s=>`${s.name} — ${s.status}${s.overdue?' (Overdue)':''} ${s.status==='Break'? '(Break '+fmtSecs(s.breakElapsed)+')' : s.status==='Lunch'? '(Lunch '+fmtSecs(s.lunchElapsed)+')' : ''} • ${s.role}${s.sub? ' / '+s.sub:''}`)
  ].join('\n');
  reportText.textContent = rpt;
}
exportBtn.addEventListener('click', ()=>{ const blob = new Blob([ JSON.stringify({ pallets:DB.load('pallets',[]), audits:DB.load('audits',[]), staff:DB.load('staff',[]) }, null, 2) ], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='backroom-data.json'; a.click(); URL.revokeObjectURL(url); });
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', ()=>{ const f = importFile.files[0]; if(!f) return; const rd = new FileReader(); rd.onload = ()=>{ try{ const obj = JSON.parse(rd.result); if(obj.pallets) DB.save('pallets', obj.pallets); if(obj.audits) DB.save('audits', obj.audits); if(obj.staff) DB.save('staff', obj.staff); pallets = DB.load('pallets', []); staff = DB.load('staff', []); audits = DB.load('audits', []); renderPallets(); renderStaff(); renderAudit(); renderReport(); }catch(e){ alert('Invalid file.'); } }; rd.readAsText(f); });

/*************** Controls wiring ***************/
document.getElementById('filterRole').addEventListener('change', renderStaff);
document.getElementById('filterSub').addEventListener('change', renderStaff);
document.getElementById('compactToggle').addEventListener('change', (e)=>{ document.body.classList.toggle('compact', e.target.checked); });
document.getElementById('addEmp').addEventListener('click', ()=>{ setStaffCount(staff.length+1); document.getElementById('empCount').value = staff.length; });
document.getElementById('removeEmp').addEventListener('click', ()=>{ setStaffCount(staff.length-1); document.getElementById('empCount').value = staff.length; });
document.getElementById('empCount').addEventListener('change', (e)=>{ setStaffCount(parseInt(e.target.value||'1',10)); e.target.value = staff.length; });
document.getElementById('applyPreset').addEventListener('click', ()=>{ const name = document.getElementById('presetSelect').value; // assign next unnamed or append new
  const idx = staff.findIndex(s=>s.name.startsWith('Employee '));
  if(idx>=0){ staff[idx].name = name; } else { staff.push({ name, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false, overdueSince:null, role:'Unloading', sub:'' }); }
  DB.save('staff', staff); setStaffCount(Math.min(10, staff.length)); renderStaff();
});
document.getElementById('notifBtn').addEventListener('click', async ()=>{ try{ await Notification.requestPermission(); alert('Notification permission: '+Notification.permission); }catch{ alert('Notifications not available.'); }});
document.getElementById('muteToggle').checked = DB.load('mute', false) ? true : false;
document.getElementById('muteToggle').addEventListener('change', (e)=>{ DB.save('mute', e.target.checked); if(!e.target.checked) AudioBus.resume(); });
document.getElementById('volSlider').value = Number(DB.load('vol','0.8'));
document.getElementById('volSlider').addEventListener('input', (e)=> AudioBus.setVolume(Number(e.target.value)));
document.getElementById('testBreak').addEventListener('click', ()=>{ AudioBus.resume(); AudioBus.chimeBreak(false); });
document.getElementById('testPallet').addEventListener('click', ()=>{ AudioBus.resume(); AudioBus.chimePallet(false); });

/*************** Boot ***************/
function boot(){
  // Pallets
  if(pallets.length===0){ pallets = Array.from({length:3}, (_,i)=> ({...structuredClone(palletDefaults), type: palletTypes[i%3]})); DB.save('pallets', pallets); }
  renderPallets();
  // Staff
  if(staff.length===0){ staff = Array.from({length:6}, (_,i)=> ({ name:`Employee ${i+1}`, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false, overdueSince:null, role:'Unloading', sub:'' })); DB.save('staff', staff); }
  document.getElementById('empCount').value = staff.length;
  renderStaff();
  // Audit
  initAuditSelectors(); renderAudit();
}
boot();
</script>
</body>
</html>
