<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Backroom Ops — Mobile</title>
<style>
  :root{
    --bg:#0b1020; --panel:#111935; --panel-2:#162045; --ink:#eaf0ff; --muted:#b7c2e8; --line:#3a4a7a;
    --accent:#6aa6ff; --good:#63e27a; --warn:#ffd24a; --bad:#ff6b6b; --info:#7bd8ff;
    --role-unload:#15c0b0; --role-sort:#4ea2ff; --role-hang:#b266ff; --role-proc:#ffcc55;
  }
  html,body{height:100%;}
  body{margin:0;background:radial-gradient(1200px 1200px at 10% 0%,#131c3a 0%,var(--bg) 60%);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .app{max-width:900px;margin:0 auto;padding:12px;}
  .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .logo{display:flex;align-items:center;gap:8px;font-weight:800;letter-spacing:.3px}
  .logo svg{width:24px;height:24px}
  .tabs{display:flex;gap:6px;margin-left:auto;flex-wrap:wrap}
  .tab{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);padding:8px 10px;border-radius:10px;color:var(--ink);cursor:pointer}
  .tab[hidden]{display:none}
  .tab.active{outline:2px solid var(--accent);}
  .panel{background:linear-gradient(180deg,var(--panel),rgba(22,32,69,.7));border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .grid{display:grid;gap:10px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  input,select,button,textarea{font-size:15px}
  input[type="number"],input[type="text"],select,textarea{background:#0f1630;border:1px solid var(--line);color:var(--ink);padding:10px 10px;border-radius:10px;outline:none;min-height:40px}
  textarea{width:100%;min-height:80px;resize:vertical}
  button{background:linear-gradient(180deg,#1a2550,#14204a);border:1px solid var(--line);color:var(--ink);padding:10px;border-radius:12px;cursor:pointer;min-height:40px}
  button:hover{filter:brightness(1.05)}
  .hint{color:var(--muted);font-size:12px}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0e183a;font-size:12px}
  .pill{padding:4px 10px;border-radius:999px;background:#0e183a;border:1px solid var(--line)}
  .section-title{display:flex;align-items:center;gap:8px;margin:4px 0 10px 0;font-weight:700}
  .section-title svg{width:18px;height:18px}

  .card{background:linear-gradient(180deg,#121d3f,#0d142e);border:1px solid var(--line);padding:10px;border-radius:14px;position:relative;overflow:hidden}
  .card .title{font-weight:700}
  .sub{font-size:12px;color:var(--muted)}
  .role-badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line)}
  .role-unload{background:rgba(21,192,176,.18);color:#a6fff6}
  .role-sort{background:rgba(78,162,255,.18);color:#cfe4ff}
  .role-hang{background:rgba(178,102,255,.18);color:#eed9ff}
  .role-proc{background:rgba(255,204,85,.18);color:#fff2cc}
  .role-emoji{font-size:14px}

  .status{font-weight:700}
  .s-working{color:var(--good)}
  .s-break{color:var(--info)}
  .s-lunch{color:var(--warn)}
  .s-overdue{color:var(--bad)}
  .blink{animation:blink 1s steps(2,end) infinite}
  @keyframes blink{50%{opacity:.35}}
  .card.overdue{border-color:var(--bad); box-shadow:0 0 0 0 rgba(255,107,107,.6); animation:pulseRed 1s infinite}
  @keyframes pulseRed{0%{box-shadow:0 0 0 0 rgba(255,107,107,.6)} 70%{box-shadow:0 0 0 10px rgba(255,107,107,0)} 100%{box-shadow:0 0 0 0 rgba(255,107,107,0)}}

  .ring{--size:50; --stroke:6; width:var(--size)px;height:var(--size)px}
  .ring svg{transform:rotate(-90deg)}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
  .modal .sheet{background:linear-gradient(180deg,#17224a,#11193a);border:1px solid var(--line);border-radius:16px;padding:16px;max-width:420px;width:100%}

  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .controls > *{flex:1 1 130px}
  .thin{min-width:0}

  .compact .card{padding:8px}
  .compact .ring{--size:40; --stroke:5}
  .compact .title{font-size:14px}
  .compact .sub{font-size:11px}

  @media (max-width:900px){ .grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:640px){ .grid.cols-3,.grid.cols-2{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="logo" title="Backroom Ops">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18M5 7v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7" stroke="#7bd8ff" stroke-width="1.5"/><rect x="7" y="3" width="10" height="4" rx="1" stroke="#6aa6ff" stroke-width="1.5"/><path d="M9 11h6m-6 4h4" stroke="#9ad1ff" stroke-width="1.5"/></svg>
      <span>Backroom Ops</span>
      <span class="pill">Mobile</span>
    </div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="pallets">Pallets</div>
      <div class="tab" data-tab="staff">Staffing</div>
      <div class="tab" data-tab="audit">Audit</div>
      <div class="tab" data-tab="backstock">Back Stock</div>
      <div class="tab" data-tab="eod">EOD</div>
      <div class="tab" data-tab="reports">Reports</div>
    </div>
  </div>

  <!-- PALLETS -->
  <section class="panel" id="tab-pallets">
    <div class="section-title">
      <span>Pallet Tracking</span>
      <span class="spacer"></span>
      <button id="startDayBtn" title="Mark shift start">Start Day</button>
      <button id="endDayBtn" title="Open End of Day">End Day</button>
      <span class="pill" id="shiftBadge" title="Shift window" style="display:none"></span>
    </div>
    <div class="row">
      <label class="hint">How many pallets?</label>
      <input id="palletCount" type="number" min="0" max="12" step="1" value="3" />
      <button id="setupPallets">Setup</button>
      <button id="clearPallets" title="Remove saved pallets">Clear</button>
      <span class="spacer"></span>
      <span class="hint">Type cycles: Standard → 2-Wave → 4-Wave</span>
    </div>
    <div id="palletGrid" class="grid cols-3" style="margin-top:10px"></div>

    <div class="row" style="margin-top:8px">
      <div class="tag">Pallet chime: separate sound • Mute/Volume in Staffing</div>
    </div>
  </section>

  <!-- STAFFING -->
  <section class="panel" id="tab-staff" hidden>
    <div class="section-title">
      <span>Staffing</span>
      <span class="spacer"></span>
      <label class="row" style="gap:6px">
        <input type="checkbox" id="compactToggle"/> <span class="hint">Compact mode</span>
      </label>
    </div>

    <!-- Quick controls -->
    <div class="controls" style="margin-bottom:8px">
      <div class="row thin">
        <label class="hint">Employees (1–10)</label>
        <input id="empCount" type="number" min="1" max="10" value="6" class="thin"/>
        <button id="addEmp">Add</button>
        <button id="removeEmp">Remove</button>
      </div>
      <div class="row thin">
        <select id="presetSelect" class="spacer">
          <option>Alex</option><option>Danny</option><option>Riley-L</option><option>Jada</option>
          <option>Jaden</option><option>Aiden</option><option>Hannah</option><option>Zena</option>
          <option>April</option><option>Carrissa (OTN)</option><option>Ok</option>
        </select>
        <button id="applyPreset">Name next</button>
      </div>
      <div class="row thin">
        <label class="hint">Role filter</label>
        <select id="filterRole" class="spacer">
          <option value="">All roles</option>
          <option>Unloading</option><option>Sorting</option><option>Hanging</option><option>Processing</option>
        </select>
      </div>
      <div class="row thin">
        <label class="hint">Sub-task</label>
        <select id="filterSub" class="spacer">
          <option value="">All sub-tasks</option>
          <option>Shoes</option><option>Luggage</option><option>Purses</option><option>Furniture</option>
        </select>
      </div>
    </div>

    <!-- Alerts & audio -->
    <div class="panel" style="margin:8px 0">
      <div class="row">
        <strong>Alerts & Chimes</strong><span class="spacer"></span>
        <button id="notifBtn">Enable desktop notifications</button>
      </div>
      <div class="row">
        <label class="row" style="gap:6px"><input type="checkbox" id="muteToggle"> Mute</label>
        <label>Volume <input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.8"></label>
        <button id="testBreak">Test Break Chime</button>
        <button id="testPallet">Test Pallet Chime</button>
      </div>
      <div class="row">
        <span class="tag">Break 15m • Lunch 45m</span>
        <span class="tag">Escalation: 5m pulse • 10m double-chime</span>
      </div>
    </div>

    <div id="staffGrid" class="grid cols-2" style="margin-top:8px"></div>
  </section>

  <!-- AUDIT -->
  <section class="panel" id="tab-audit" hidden>
    <div class="section-title"><span>Audit Mode</span><span class="spacer"></span><button id="undoAudit" title="Remove last audit entry">Undo last</button></div>
    <div class="row">
      <label>Category</label><select id="auditCat"></select>
      <label>Subcategory</label><select id="auditSub"></select>
      <label>Count</label><input id="auditCount" type="number" min="1" value="1" style="width:90px">
      <button id="auditRecord">Record</button><span class="spacer"></span><span class="hint">Saved locally</span>
    </div>
    <div id="auditLog" style="margin-top:10px" class="grid"></div>
  </section>

  <!-- BACK STOCK -->
  <section class="panel" id="tab-backstock" hidden>
    <div class="section-title">
      <span>Back Stock</span>
      <span class="spacer"></span>
      <span class="hint">Store by department; apparel pallets auto→totes (×32)</span>
    </div>
    <div class="grid cols-2">
      <div class="card">
        <div class="title">New Entry</div>
        <div class="row" style="margin-top:6px">
          <label class="hint">Category</label>
          <select id="bsCategory" class="spacer">
            <option>Home</option>
            <option>Beauty</option>
            <option>Apparel</option>
            <option>Furniture</option>
            <option>Luggage</option>
          </select>
        </div>
        <div class="row">
          <label class="hint">Department #</label>
          <input id="bsDept" type="text" placeholder="e.g., 602 Kitchen" class="spacer">
        </div>
        <div class="row">
          <label class="hint">Unit</label>
          <select id="bsUnit" class="spacer">
            <option>Pieces</option>
            <option>Totes</option>
            <option>Bins</option>
            <option>Pallets</option>
          </select>
          <label class="hint">Quantity</label>
          <input id="bsQty" type="number" min="0" value="0" style="width:130px">
        </div>
        <div class="row">
          <label class="hint">Description</label>
          <input id="bsDesc" type="text" placeholder="Short description..." class="spacer">
        </div>
        <div class="row">
          <span class="spacer"></span>
          <button id="bsAdd">Add</button>
          <button id="bsClear">Clear All</button>
        </div>
        <div id="bsInfo" class="hint" style="margin-top:6px"></div>
      </div>
      <div class="card">
        <div class="title">By Department</div>
        <div id="bsList" style="margin-top:6px" class="grid"></div>
      </div>
    </div>
  </section>

  <!-- EOD -->
  <section class="panel" id="tab-eod" hidden>
    <div class="section-title">
      <span>End of Day</span>
      <span class="spacer"></span>
      <button id="eodShare">Share</button>
      <button id="eodCopy">Copy</button>
      <button id="eodExport">Export JSON</button>
    </div>

    <div class="grid cols-2">
      <div class="card" id="eodMetricsCard">
        <div class="title">Metrics</div>
        <div id="eodMetrics" class="sub" style="margin-top:6px;white-space:pre-wrap"></div>
      </div>
      <div class="card">
        <div class="title">Ready to Go to Floor</div>
        <div class="row" style="margin-top:6px">
          <label class="hint">Department</label>
          <select id="floorDept" class="spacer">
            <option>Kitchen</option>
            <option>Beauty</option>
            <option>Mens Acc</option>
            <option>Mens Apparel</option>
            <option>Women's Apparel</option>
            <option>Kids Apparel</option>
            <option>Intiments</option>
            <option>Toys</option>
            <option>Mens</option>
            <option>Women's</option>
            <option>Active</option>
          </select>
        </div>
        <div class="row">
          <label class="hint">Unit</label>
          <select id="floorUnit" class="spacer">
            <option>Totes</option>
            <option>Bins</option>
            <option>Racks</option>
            <option>Pieces</option>
          </select>
          <label class="hint">Quantity</label>
          <input id="floorQty" type="number" min="0" value="0" style="width:130px">
        </div>
        <div class="row">
          <label class="hint">Notes / Comments</label>
          <textarea id="floorNotes" placeholder="Notes..."></textarea>
        </div>
        <div class="row">
          <span class="spacer"></span>
          <button id="floorAdd">Add Entry</button>
          <button id="floorClear">Clear All</button>
        </div>
        <div id="floorList" class="grid" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="title">Compiled End of Day Report</div>
      <div id="eodText" style="white-space:pre-wrap;margin-top:6px"></div>
    </div>
  </section>

  <!-- REPORTS -->
  <section class="panel" id="tab-reports" hidden>
    <div class="section-title"><span>Reports</span><span class="spacer"></span><button id="exportBtn">Export JSON</button><input id="importFile" type="file" accept="application/json" hidden /><button id="importBtn">Import JSON</button></div>
    <div id="reportText" style="white-space:pre-wrap"></div>
  </section>
</div>

<!-- Modal: rename employee -->
<div class="modal" id="nameModal">
  <div class="sheet">
    <div class="section-title"><span>Rename Employee</span></div>
    <div class="row"><input type="text" id="nameInput" placeholder="e.g., Alex" class="spacer"></div>
    <div class="row" style="margin-top:12px"><span class="spacer"></span><button id="nameCancel">Cancel</button><button id="nameSave">Save</button></div>
  </div>
</div>

<script>
/*************** Local DB ***************/
const DB = {
  load(key, def){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); }catch{ return def } },
  save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
};

/*************** Tabs ***************/
const sections = {
  pallets: document.getElementById('tab-pallets'),
  staff: document.getElementById('tab-staff'),
  audit: document.getElementById('tab-audit'),
  backstock: document.getElementById('tab-backstock'),
  eod: document.getElementById('tab-eod'),
  reports: document.getElementById('tab-reports')
};
document.getElementById('tabs').addEventListener('click', (e)=>{
  const t = e.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tab = t.dataset.tab;
  for(const [k,sec] of Object.entries(sections)) sec.hidden = (k!==tab);
  if(tab==='reports') renderReport();
  if(tab==='eod') renderEOD();
});

/*************** Helpers ***************/
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
function fmtSecs(s){ const m=Math.floor(s/60), ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}` }
function fmtHM(totalSeconds){
  const h = Math.floor(totalSeconds/3600);
  const m = Math.floor((totalSeconds%3600)/60);
  return `${h}h ${m}m`;
}
function ring(percent){
  const size=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ring-size')||'50')||50;
  const stroke=6, r=(size-stroke)/2, c=2*Math.PI*r, off=c*(1-Math.max(0,Math.min(1,percent)));
  return `<div class="ring"><svg width="${size}" height="${size}"><circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="#223067" stroke-width="${stroke}" fill="none"/><circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="#7bd8ff" stroke-width="${stroke}" stroke-linecap="round" fill="none" stroke-dasharray="${c}" stroke-dashoffset="${off}"/></svg></div>`;
}
const ROLE_ICON = { Unloading:'📦', Sorting:'🔀', Hanging:'👗', Processing:'🛠️' };
const ROLE_BADGE = { Unloading:'role-unload', Sorting:'role-sort', Hanging:'role-hang', Processing:'role-proc' };

/*************** Web Audio (chimes) ***************/
const AudioBus = (()=>{
  let ctx, gain;
  function ensure(){
    if(!ctx){ ctx = new (window.AudioContext||window.webkitAudioContext)(); gain = ctx.createGain(); gain.gain.value = Number(DB.load('vol','0.8')); gain.connect(ctx.destination); }
  }
  function setVolume(v){ ensure(); gain.gain.value=v; DB.save('vol', String(v)); }
  function beep(seq){
    ensure(); if(DB.load('mute', false)) return;
    let t = ctx.currentTime;
    seq.forEach(({f=880,d=0.15})=>{
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(gain);
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(0.9, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+d);
      o.start(t); o.stop(t+d+0.02);
      t += d + 0.05;
    });
  }
  function chimeBreak(escalated=false){
    const base = [{f:988,d:0.12},{f:1319,d:0.12}];
    beep(escalated? base.concat(base) : base);
  }
  function chimePallet(escalated=false){
    const base = [{f:660,d:0.12},{f:880,d:0.12}];
    beep(escalated? base.concat(base) : base);
  }
  function resume(){ ensure(); ctx.resume?.(); }
  return { setVolume, chimeBreak, chimePallet, resume };
})();

/*************** Notifications ***************/
async function notify(title, body){
  try{
    if(Notification.permission==='default'){ await Notification.requestPermission(); }
    if(Notification.permission==='granted'){ new Notification(title, { body }); }
  }catch{}
}

/*************** Shift / EOD storage ***************/
let shift = DB.load('shift', { startTime:null, endTime:null });
let eod = DB.load('eod', { floor:[], lastReportText:"" });

function setShiftStart(ts=Date.now()){
  shift.startTime = shift.startTime || ts;
  DB.save('shift', shift);
  paintShiftBadge();
}
function setShiftEnd(ts=Date.now()){
  shift.endTime = ts;
  DB.save('shift', shift);
}
function clearShift(){ shift = { startTime:null, endTime:null }; DB.save('shift', shift); paintShiftBadge(); }
function paintShiftBadge(){
  const b = document.getElementById('shiftBadge');
  if(shift.startTime){
    const s = new Date(shift.startTime).toLocaleTimeString();
    const e = shift.endTime ? new Date(shift.endTime).toLocaleTimeString() : '…';
    b.textContent = `Shift: ${s} – ${e}`;
    b.style.display = '';
  }else{
    b.style.display = 'none';
  }
}

/*************** Pallets ***************/
const palletTypes = ["Standard","2-Wave","4-Wave"];
const palletDefaults = { type:"Standard", duration: 15*60, remaining: 15*60, cartons:0, status:"Not Started", startedAt:null, complete:false, overdue:false, overdueSince:null, completedAt:null };
const palletGrid = document.getElementById('palletGrid');
let pallets = DB.load('pallets', []);
let palletTimers = new Map();

function makePallet(i, data){
  const p = { ...structuredClone(palletDefaults), ...data };
  const id = i;
  const card = el(`<div class="card" data-id="${id}">
    <div class="row" style="align-items:flex-start;gap:10px">
      ${ring(1 - (p.remaining/p.duration))}
      <div class="spacer">
        <div class="title">Pallet #${id+1} <span class="sub">• <span class="ptype">${p.type}</span></span></div>
        <div class="sub">Time Left: <span class="tleft">${fmtSecs(p.remaining)}</span> · Cartons: <span class="cartons">${p.cartons}</span></div>
        <div class="sub">Status: <span class="status ${p.overdue? 's-overdue blink': p.complete? 's-working' : (p.status==='In Progress'?'s-working':'' )}">${p.overdue? 'Overdue': p.complete? 'Complete': p.status}</span></div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="startBtn">Start</button>
      <button class="cartonBtn">+1</button>
      <button class="typeBtn">Type</button>
      <span class="spacer"></span>
      <button class="completeBtn">Complete</button>
    </div>
  </div>`);
  const tleft = card.querySelector('.tleft');
  const cartonsEl = card.querySelector('.cartons');
  const statusEl = card.querySelector('.status');
  const ptypeEl = card.querySelector('.ptype');

  function paint(){
    tleft.textContent = fmtSecs(p.remaining);
    cartonsEl.textContent = p.cartons;
    ptypeEl.textContent = p.type;
    statusEl.textContent = p.overdue? 'Overdue' : (p.complete? 'Complete' : p.status);
    statusEl.className = 'status ' + (p.overdue? 's-overdue blink' : p.complete? 's-working' : (p.status==='In Progress'?'s-working':'') );
    const pct = 1 - (p.remaining/p.duration);
    card.querySelector('.ring').outerHTML = ring(pct);
    card.classList.toggle('overdue', !!p.overdue);
  }
  function tick(){
    if(p.complete||p.status!=='In Progress') return;
    if(p.remaining>0){ p.remaining = Math.max(0, p.remaining-1); }
    if(p.remaining===0 && !p.overdue){
      p.overdue = true; p.overdueSince = Date.now();
      AudioBus.chimePallet(false); notify('Pallet overdue', `Pallet #${id+1} is overdue`);
    } else if(p.overdue){
      const overSec = Math.floor((Date.now()-p.overdueSince)/1000);
      if(overSec!==0 && overSec%120===0){ AudioBus.chimePallet(false); } // repeat every 2m
      if(overSec===600){ AudioBus.chimePallet(true); } // 10m double
    }
    paint(); save();
  }
  function startTimer(){ stopTimer(); palletTimers.set(id, setInterval(tick, 1000)); }
  function stopTimer(){ const t=palletTimers.get(id); if(t){ clearInterval(t); palletTimers.delete(id);} }

  card.querySelector('.startBtn').addEventListener('click', ()=>{
    if(p.status==='Not Started'){
      p.status='In Progress'; p.startedAt=Date.now();
      // mark shift start at first pallet start if not set
      setShiftStart(p.startedAt);
      startTimer(); save(); paint();
    }
  });
  card.querySelector('.cartonBtn').addEventListener('click', ()=>{ p.cartons++; paint(); save(); });
  card.querySelector('.typeBtn').addEventListener('click', ()=>{ const idx = palletTypes.indexOf(p.type); p.type = palletTypes[(idx+1)%palletTypes.length]; paint(); save(); });
  card.querySelector('.completeBtn').addEventListener('click', ()=>{
    if(!p.complete){
      p.complete=true; p.status='Complete'; p.overdue=false; p.completedAt = Date.now();
      stopTimer(); paint(); save();
      // if all pallets that exist are completed, open EOD
      setTimeout(checkAllPalletsComplete, 150);
    }
  });

  function save(){ pallets[id]=p; DB.save('pallets', pallets);} 
  paint();
  return card;
}
function renderPallets(){ palletGrid.innerHTML=''; pallets.forEach((p,i)=> palletGrid.appendChild(makePallet(i,p)) ); }
document.getElementById('setupPallets').addEventListener('click', ()=>{
  const n = Math.max(0, parseInt(document.getElementById('palletCount').value||'0',10));
  pallets = Array.from({length:n}, (_,i)=> ({...structuredClone(palletDefaults), type: palletTypes[i%3]}));
  DB.save('pallets', pallets); renderPallets();
});
document.getElementById('clearPallets').addEventListener('click', ()=>{ pallets=[]; DB.save('pallets', pallets); renderPallets(); });

/*************** Staffing ***************/
const staffGrid = document.getElementById('staffGrid');
const breakLimitSecs = 15*60; // 15m
const lunchLimitSecs = 45*60; // 45m
const PRESETS = ["Alex","Danny","Riley-L","Jada","Jaden","Aiden","Hannah","Zena","April","Carrissa (OTN)","Ok"];
let staff = DB.load('staff', []); // { name, status, breakElapsed, lunchElapsed, overdue, role, sub, overdueSince }
let staffTimers = new Map();

function roleEmoji(role){ return ROLE_ICON[role]||'•'; }
function roleBadge(role){ return ROLE_BADGE[role]||''; }

function makeStaff(i, data){
  const s = { name:`Employee ${i+1}`, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false, overdueSince:null, role:'Unloading', sub:'', ...data };
  const card = el(`<div class="card" data-id="${i}">
    <div class="row" style="align-items:center;gap:8px">
      ${ring(0)}
      <div class="spacer">
        <div class="title">
          <span class="empName" style="cursor:text">${s.name}</span>
          <span class="sub">• <span class="status ${cls()}">${label()}</span></span>
        </div>
        <div class="sub">Timer: <span class="timer">0:00</span></div>
        <div class="row" style="margin-top:4px">
          <span class="role-badge ${roleBadge(s.role)}"><span class="role-emoji">${roleEmoji(s.role)}</span> <span class="roleText">${s.role}</span></span>
          <span class="pill subPill" ${s.role==='Processing' && s.sub ? '' : 'style="display:none"'}>${s.sub||''}</span>
        </div>
      </div>
      <button class="resetBtn" title="Reset timers">Reset</button>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="breakBtn" title="Start a 15-minute break">Break 15</button>
      <button class="lunchBtn" title="Start a 45-minute lunch">Lunch 45</button>
      <button class="renameBtn">Rename</button>
      <span class="spacer"></span>
      <select class="roleSel">
        <option>Unloading</option><option>Sorting</option><option>Hanging</option><option>Processing</option>
      </select>
      <select class="subSel" ${s.role==='Processing'?'':'style="display:none"'} >
        <option value="">— Sub-task —</option><option>Shoes</option><option>Luggage</option><option>Purses</option><option>Furniture</option>
      </select>
    </div>
  </div>`);

  const statusEl = card.querySelector('.status');
  const timerEl = card.querySelector('.timer');
  const nameEl = card.querySelector('.empName');
  const breakBtn = card.querySelector('.breakBtn');
  const lunchBtn = card.querySelector('.lunchBtn');
  const renameBtn = card.querySelector('.renameBtn');
  const resetBtn = card.querySelector('.resetBtn');
  const roleSel = card.querySelector('.roleSel');
  const subSel = card.querySelector('.subSel');
  const roleText = card.querySelector('.roleText');
  const subPill = card.querySelector('.subPill');

  roleSel.value = s.role;
  subSel.value = s.sub || "";

  function cls(){ return s.overdue? 's-overdue blink' : s.status==='Working'? 's-working' : s.status==='Break'? 's-break' : 's-lunch'; }
  function label(){ return s.overdue? 'Overdue' : s.status; }

  function paint(){
    statusEl.className = 'status ' + cls();
    statusEl.textContent = label();
    const elapsed = s.status==='Break'? s.breakElapsed : s.status==='Lunch'? s.lunchElapsed : 0;
    timerEl.textContent = fmtSecs(elapsed);
    const lim = s.status==='Break'? breakLimitSecs : s.status==='Lunch'? lunchLimitSecs : 1;
    const pct = Math.min(1, elapsed/lim);
    card.querySelector('.ring').outerHTML = ring(pct);
    card.classList.toggle('overdue', !!s.overdue);
    roleText.textContent = s.role;
    card.querySelector('.role-badge').className = 'role-badge ' + roleBadge(s.role);
    card.querySelector('.role-emoji').textContent = roleEmoji(s.role);
    subPill.textContent = s.sub||'';
    subPill.style.display = (s.role==='Processing' && s.sub)? '' : 'none';
  }

  function save(){ staff[i]=s; DB.save('staff', staff); }

  function stop(){ const t=staffTimers.get(i); if(t){ clearInterval(t); staffTimers.delete(i);} }
  function start(){ stop(); staffTimers.set(i, setInterval(()=>{
    if(s.status==='Break'){ s.breakElapsed++; if(s.breakElapsed>breakLimitSecs){ onOverdue(); }}
    else if(s.status==='Lunch'){ s.lunchElapsed++; if(s.lunchElapsed>lunchLimitSecs){ onOverdue(); }}
    else { s.overdue=false; s.overdueSince=null; }
    if(s.overdue && s.overdueSince){
      const overSec = Math.floor((Date.now()-s.overdueSince)/1000);
      if(overSec!==0 && overSec%120===0){ AudioBus.chimeBreak(false); }
      if(overSec===600){ AudioBus.chimeBreak(true); }
    }
    paint(); save();
  },1000)); }

  function onOverdue(){
    if(!s.overdue){ s.overdue=true; s.overdueSince=Date.now(); AudioBus.chimeBreak(false); notify('Break/Lunch overdue', `${s.name} • ${s.status}`); }
  }

  card.addEventListener('click', (e)=>{
    if(e.target.closest('button')|| e.target.closest('select')|| e.target===nameEl) return;
    if(s.status==='Working'){ s.status='Break'; s.overdue=false; s.overdueSince=null; start(); }
    else if(s.status==='Break'){ s.status='Lunch'; s.overdue=false; s.overdueSince=null; start(); }
    else { s.status='Working'; s.overdue=false; s.overdueSince=null; stop(); }
    paint(); save();
  });

  resetBtn.addEventListener('click', (e)=>{ e.stopPropagation(); s.breakElapsed=0; s.lunchElapsed=0; s.overdue=false; s.overdueSince=null; paint(); save(); });
  breakBtn.addEventListener('click', (e)=>{ e.stopPropagation(); s.status='Break'; s.overdue=false; s.overdueSince=null; s.breakElapsed=0; start(); paint(); save(); });
  lunchBtn.addEventListener('click', (e)=>{ e.stopPropagation(); s.status='Lunch'; s.overdue=false; s.overdueSince=null; s.lunchElapsed=0; start(); paint(); save(); });
  renameBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openNameModal(s.name, (newName)=>{ s.name=newName||s.name; nameEl.textContent=s.name; paint(); save(); }); });

  roleSel.addEventListener('change', ()=>{ s.role = roleSel.value; if(s.role!=='Processing'){ s.sub=''; subSel.value=""; } subSel.style.display = s.role==='Processing' ? '' : 'none'; paint(); save(); });
  subSel.addEventListener('change', ()=>{ s.sub = subSel.value || ''; paint(); save(); });

  paint();
  return card;
}

function renderStaff(){
  staffGrid.innerHTML='';
  const r = document.getElementById('filterRole').value;
  const sub = document.getElementById('filterSub').value;
  staff.forEach((s,i)=>{
    if(r && s.role!==r) return;
    if(sub && s.sub!==sub) return;
    staffGrid.appendChild(makeStaff(i,s));
  });
}

function setStaffCount(n){
  n = Math.max(1, Math.min(10, n));
  const curr = staff.length;
  if(n>curr){
    const start = curr;
    for(let k=0;k<n-curr;k++){
      const name = PRESETS[(start+k)%PRESETS.length] || `Employee ${start+k+1}`;
      staff.push({ name, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false, overdueSince:null, role:'Unloading', sub:'' });
    }
  }else if(n<curr){
    staff.length = n;
  }
  DB.save('staff', staff);
  renderStaff();
}

/*************** Name modal ***************/
const nameModal = document.getElementById('nameModal');
const nameInput = document.getElementById('nameInput');
const nameCancel = document.getElementById('nameCancel');
const nameSave = document.getElementById('nameSave');
function openNameModal(curr, cb){
  nameInput.value=curr; nameModal.style.display='flex'; nameInput.focus();
  const onSave=()=>{ nameModal.style.display='none'; cleanup(); cb(nameInput.value.trim()); };
  const onCancel=()=>{ nameModal.style.display='none'; cleanup(); };
  function onKey(e){ if(e.key==='Enter') onSave(); if(e.key==='Escape') onCancel(); }
  function cleanup(){ nameSave.removeEventListener('click', onSave); nameCancel.removeEventListener('click', onCancel); document.removeEventListener('keydown', onKey); }
  nameSave.addEventListener('click', onSave); nameCancel.addEventListener('click', onCancel); document.addEventListener('keydown', onKey);
}

/*************** Audit ***************/
const auditCat = document.getElementById('auditCat');
const auditSub = document.getElementById('auditSub');
const auditCount = document.getElementById('auditCount');
const auditRecordBtn = document.getElementById('auditRecord');
const auditLog = document.getElementById('auditLog');
const undoAuditBtn = document.getElementById('undoAudit');
const defaultCats = {
  "Home":["Food","Décor","Kitchen","Miscellaneous"],
  "Assorted":["Mixed Home","Mixed Beauty","Random"],
  "Active":["Water Bottles","Weights","Miscellaneous"],
  "Shoes & Apparel":["GOH","Folded"],
  "Luggage":["Large","Small"],
  "Toys":["Large","Small"],
  "Miscellaneous":["Bed Pillows","Baskets","Yoga Mats"]
};
let audits = DB.load('audits', []);
function initAuditSelectors(){ auditCat.innerHTML = Object.keys(defaultCats).map(k=>`<option>${k}</option>`).join(''); fillSubs(); }
function fillSubs(){ const k=auditCat.value; auditSub.innerHTML = defaultCats[k].map(s=>`<option>${s}</option>`).join(''); }
auditCat.addEventListener('change', fillSubs);
auditRecordBtn.addEventListener('click', ()=>{ const entry = { pallet_id: 1, category: auditCat.value, subcategory: auditSub.value, count: parseInt(auditCount.value||'1',10), timestamp: new Date().toISOString() }; audits.push(entry); DB.save('audits', audits); renderAudit(); });
undoAuditBtn.addEventListener('click', ()=>{ audits.pop(); DB.save('audits', audits); renderAudit(); });
function renderAudit(){ auditLog.innerHTML = ''; if(audits.length===0){ auditLog.appendChild(el(`<div class="hint">No audit records yet.</div>`)); return; } [...audits].reverse().forEach((a)=>{ auditLog.appendChild(el(`<div class="card"><div class="row"><div class="title">${a.category} • ${a.subcategory}</div><span class="spacer"></span><span class="pill">x${a.count}</span></div><div class="sub">${new Date(a.timestamp).toLocaleString()}</div></div>`)); }); }

/*************** Back Stock ***************/
let backstock = DB.load('backstock', []); // {category, dept, unit, qty, desc, totesEq, timestamp}
const bsCategory = document.getElementById('bsCategory');
const bsDept = document.getElementById('bsDept');
const bsUnit = document.getElementById('bsUnit');
const bsQty = document.getElementById('bsQty');
const bsDesc = document.getElementById('bsDesc');
const bsAdd = document.getElementById('bsAdd');
const bsClear = document.getElementById('bsClear');
const bsList = document.getElementById('bsList');
const bsInfo = document.getElementById('bsInfo');

function renderBackstock(){
  bsList.innerHTML='';
  if(backstock.length===0){ bsList.appendChild(el(`<div class="hint">No back stock yet.</div>`)); bsInfo.textContent=''; return; }
  // group by department
  const map = new Map();
  backstock.forEach(e=>{
    const k = e.dept.trim()||'(no dept)';
    if(!map.has(k)) map.set(k, []);
    map.get(k).push(e);
  });
  Array.from(map.entries()).sort().forEach(([dept, entries])=>{
    const totalLine = (()=> {
      // show small totals by unit within dept
      const unitTotals = {};
      entries.forEach(e=>{ unitTotals[e.unit]=(unitTotals[e.unit]||0)+e.qty; });
      const parts = Object.entries(unitTotals).map(([u,q])=>`${q} ${u.toLowerCase()}`);
      return parts.join(' • ') || '';
    })();
    const card = el(`<div class="card"><div class="row"><div class="title">Dept ${dept}</div><span class="spacer"></span><span class="sub">${totalLine}</span></div></div>`);
    entries.forEach(e=>{
      const line = `${e.category} — ${e.qty} ${e.unit.toLowerCase()}${e.unit==='Pallets' && e.category==='Apparel' ? ` (≈ ${e.totesEq} totes)` : ''}${e.desc? ' • '+e.desc:''}`;
      card.appendChild(el(`<div class="sub">${new Date(e.timestamp).toLocaleTimeString()} — ${line}</div>`));
    });
    bsList.appendChild(card);
  });
  // top info
  const apparelPallets = backstock.filter(e=>e.category==='Apparel' && e.unit==='Pallets').reduce((a,b)=>a+b.qty,0);
  const totesEq = apparelPallets*32;
  bsInfo.textContent = apparelPallets? `Apparel pallets: ${apparelPallets} → approx ${totesEq} totes` : '';
}
bsAdd?.addEventListener('click', ()=>{
  const entry = {
    category: bsCategory.value,
    dept: (bsDept.value||'').trim(),
    unit: bsUnit.value,
    qty: Math.max(0, parseInt(bsQty.value||'0',10)),
    desc: (bsDesc.value||'').trim(),
    totesEq: (bsCategory.value==='Apparel' && bsUnit.value==='Pallets') ? Math.max(0, parseInt(bsQty.value||'0',10))*32 : 0,
    timestamp: new Date().toISOString()
  };
  backstock.push(entry); DB.save('backstock', backstock);
  bsQty.value = '0'; bsDesc.value = '';
  renderBackstock();
});
bsClear?.addEventListener('click', ()=>{
  if(confirm('Clear all back stock entries?')){ backstock=[]; DB.save('backstock', backstock); renderBackstock(); }
});

/*************** EOD (End of Day) ***************/
const startDayBtn = document.getElementById('startDayBtn');
const endDayBtn = document.getElementById('endDayBtn');
const eodText = document.getElementById('eodText');
const eodMetrics = document.getElementById('eodMetrics');
const eodShareBtn = document.getElementById('eodShare');
const eodCopyBtn = document.getElementById('eodCopy');
const eodExportBtn = document.getElementById('eodExport');

const floorDept = document.getElementById('floorDept');
const floorUnit = document.getElementById('floorUnit');
const floorQty = document.getElementById('floorQty');
const floorNotes = document.getElementById('floorNotes');
const floorAdd = document.getElementById('floorAdd');
const floorClear = document.getElementById('floorClear');
const floorList = document.getElementById('floorList');

function checkAllPalletsComplete(){
  const have = DB.load('pallets', []);
  if(have.length>0 && have.every(p=>p.complete)){
    openEOD();
  }
}
function openEOD(){
  // set end time if missing
  if(!shift.startTime) setShiftStart();
  setShiftEnd();
  // switch tab
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  const tabBtn = document.querySelector('.tab[data-tab="eod"]');
  tabBtn.classList.add('active');
  for(const [k,sec] of Object.entries(sections)) sec.hidden = (k!=='eod');
  renderEOD();
}
startDayBtn.addEventListener('click', ()=>{ setShiftStart(); alert('Shift started.'); });
endDayBtn.addEventListener('click', ()=> openEOD());

floorAdd?.addEventListener('click', ()=>{
  const entry = { dept: floorDept.value, unit: floorUnit.value, qty: Math.max(0, parseInt(floorQty.value||'0',10)), notes: floorNotes.value.trim(), timestamp: new Date().toISOString() };
  eod.floor.push(entry); DB.save('eod', eod); floorQty.value='0'; floorNotes.value=''; renderEODFloor();
});
floorClear?.addEventListener('click', ()=>{ if(confirm('Clear all floor-ready entries?')){ eod.floor=[]; DB.save('eod', eod); renderEODFloor(); } });

function renderEODFloor(){
  floorList.innerHTML='';
  if(eod.floor.length===0){ floorList.appendChild(el(`<div class="hint">No floor-ready entries yet.</div>`)); return; }
  [...eod.floor].reverse().forEach(f=>{
    floorList.appendChild(el(`<div class="card"><div class="row"><div class="title">${f.dept}</div><span class="spacer"></span><span class="pill">${f.qty} ${f.unit.toLowerCase()}</span></div><div class="sub">${new Date(f.timestamp).toLocaleString()}${f.notes? ' • '+f.notes:''}</div></div>`));
  });
}

function computeManHours(shiftSeconds){
  // Approximate man-hours = sum over staff of (shiftSeconds - break - lunch)
  const people = DB.load('staff', []);
  let total = 0;
  people.forEach(s=>{
    const breaks = Number(s.breakElapsed||0);
    const lunches = Number(s.lunchElapsed||0);
    const work = Math.max(0, shiftSeconds - breaks - lunches);
    total += work;
  });
  return total; // seconds
}

function palletsPerHourBuckets(pall){
  // bucket completions by hour of day
  const buckets = {};
  pall.filter(p=>p.completedAt).forEach(p=>{
    const d = new Date(p.completedAt);
    const key = d.toLocaleString([], { hour:'numeric', hour12:true });
    buckets[key] = (buckets[key]||0)+1;
  });
  return buckets; // { "2 PM": n, ...}
}

function buildEODText(metrics){
  const {start, finish, durationS, palletsDone, manHoursS, avgPerPalletS, mostHour, leastHour, buckets} = metrics;
  const lines = [];
  lines.push(`END OF DAY REPORT`);
  lines.push(`Date: ${new Date().toLocaleDateString()}`);
  lines.push(`Shift: ${start} – ${finish}`);
  lines.push(`Pallets completed: ${palletsDone}`);
  lines.push(`Total duration: ${fmtHM(durationS)}`);
  lines.push(`Man-hours: ${(manHoursS/3600).toFixed(2)} h`);
  lines.push(`Average time per pallet: ${avgPerPalletS>0? fmtHM(avgPerPalletS) : 'N/A'}`);
  lines.push(`Most productive hour: ${mostHour || 'N/A'}`);
  lines.push(`Least productive hour: ${leastHour || 'N/A'}`);
  lines.push('');
  lines.push(`Ready to Floor:`);
  if(eod.floor.length===0) lines.push(`  (none)`);
  else eod.floor.forEach(f=> lines.push(`  • ${f.dept}: ${f.qty} ${f.unit.toLowerCase()}${f.notes? ' — '+f.notes:''}`));
  lines.push('');
  lines.push(`Back Stock Summary (by department):`);
  const bs = DB.load('backstock', []);
  if(bs.length===0){ lines.push(`  (none)`); }
  else{
    const grouped = {};
    bs.forEach(e=>{
      const k = e.dept.trim()||'(no dept)';
      if(!grouped[k]) grouped[k] = [];
      grouped[k].push(e);
    });
    Object.keys(grouped).sort().forEach(k=>{
      const unitTotals = {};
      grouped[k].forEach(e=> unitTotals[e.unit]=(unitTotals[e.unit]||0)+e.qty);
      const parts = Object.entries(unitTotals).map(([u,q])=>`${q} ${u.toLowerCase()}`);
      lines.push(`  • Dept ${k}: ${parts.join(', ')}`);
    });
  }
  lines.push('');
  lines.push(`Pallets/hour breakdown:`);
  const keys = Object.keys(buckets);
  if(keys.length===0) lines.push(`  (no completions recorded)`);
  else keys.sort((a,b)=> new Date('1970-01-01 '+a) - new Date('1970-01-01 '+b)).forEach(k=> lines.push(`  • ${k}: ${buckets[k]}`));
  return lines.join('\n');
}

function renderEOD(){
  paintShiftBadge();

  const startS = shift.startTime ? new Date(shift.startTime) : new Date();
  const endS = shift.endTime ? new Date(shift.endTime) : new Date();
  const durationS = Math.max(0, Math.floor((endS - startS)/1000));
  const pall = DB.load('pallets', []);
  const palletsDone = pall.filter(p=>p.complete).length;
  const manHoursS = computeManHours(durationS);
  const avgPerPalletS = palletsDone>0 ? Math.floor(durationS / palletsDone) : 0;
  const buckets = palletsPerHourBuckets(pall);
  // most/least productive hours
  let mostHour=null, leastHour=null, max=-1, min=Infinity;
  for(const [k,v] of Object.entries(buckets)){
    if(v>max){ max=v; mostHour=k; }
    if(v<min){ min=v; leastHour=k; }
  }
  const metrics = {
    start: shift.startTime ? startS.toLocaleTimeString() : '(not set)',
    finish: shift.endTime ? endS.toLocaleTimeString() : '(not set)',
    durationS, palletsDone, manHoursS, avgPerPalletS, mostHour, leastHour, buckets
  };
  const metricsText =
`Start: ${metrics.start}
Finish: ${metrics.finish}
Duration: ${fmtHM(durationS)}
Pallets Completed: ${palletsDone}
Man-hours: ${(manHoursS/3600).toFixed(2)} h
Average per Pallet: ${avgPerPalletS>0? fmtHM(avgPerPalletS) : 'N/A'}
Most Productive Hour: ${mostHour || 'N/A'}
Least Productive Hour: ${leastHour || 'N/A'}`;
  eodMetrics.textContent = metricsText;

  renderEODFloor();

  const text = buildEODText(metrics);
  eodText.textContent = text;
  eod.lastReportText = text;
  DB.save('eod', eod);
}

eodShareBtn?.addEventListener('click', async ()=>{
  const text = eod.lastReportText || eodText.textContent || '';
  if(navigator.share){
    try{ await navigator.share({ title:'EOD Report', text }); }catch{}
  }else{
    try{ await navigator.clipboard.writeText(text); alert('Copied EOD to clipboard (no native share available).'); }catch{ alert('Copy failed.'); }
  }
});
eodCopyBtn?.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(eod.lastReportText||eodText.textContent||''); alert('Copied EOD to clipboard.'); }catch{ alert('Copy failed.'); }
});
eodExportBtn?.addEventListener('click', ()=>{
  const payload = {
    generatedAt: new Date().toISOString(),
    shift, pallets: DB.load('pallets', []), staff: DB.load('staff', []),
    backstock: DB.load('backstock', []), floor: eod.floor, eodText: eod.lastReportText
  };
  const blob = new Blob([ JSON.stringify(payload, null, 2) ], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='eod-report.json'; a.click(); URL.revokeObjectURL(url);
});

/*************** Reports ***************/
const reportText = document.getElementById('reportText');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
function renderReport(){
  const pallets = DB.load('pallets', []);
  const audits = DB.load('audits', []);
  const staff = DB.load('staff', []);
  const backstock = DB.load('backstock', []);
  const bsGrouped = {};
  backstock.forEach(e=>{
    const k = e.dept.trim()||'(no dept)';
    if(!bsGrouped[k]) bsGrouped[k] = {};
    bsGrouped[k][e.unit] = (bsGrouped[k][e.unit]||0) + e.qty;
  });
  const bsLines = Object.keys(bsGrouped).sort().map(d=>{
    const parts = Object.entries(bsGrouped[d]).map(([u,q])=>`${q} ${u.toLowerCase()}`);
    return `Dept ${d}: ${parts.join(', ')}`;
  });

  const rpt = [
    `Report generated on ${new Date().toISOString()}`,
    `Total Pallets: ${pallets.length}`,
    `Total Audits: ${audits.length}`,
    `Total Staff Entries: ${staff.length}`,
    `Back Stock Dept Count: ${Object.keys(bsGrouped).length}`,
    '',
    '— Pallets —',
    ...pallets.map((p,i)=>`#${i+1} ${p.type} • ${p.status}${p.overdue?' (Overdue)':''} • Cartons ${p.cartons} • Remaining ${fmtSecs(p.remaining)}`),
    '',
    '— Recent Audits (up to 10) —',
    ...audits.slice(-10).map(a=>`${new Date(a.timestamp).toLocaleString()} — ${a.category} / ${a.subcategory} x${a.count}`),
    '',
    '— Staff —',
    ...staff.map(s=>`${s.name} — ${s.status}${s.overdue?' (Overdue)':''} ${s.status==='Break'? '(Break '+fmtSecs(s.breakElapsed)+')' : s.status==='Lunch'? '(Lunch '+fmtSecs(s.lunchElapsed)+')' : ''} • ${s.role}${s.sub? ' / '+s.sub:''}`),
    '',
    '— Back Stock (by Department) —',
    ...(bsLines.length? bsLines : ['(none)']),
    '',
    '— Last End of Day Summary —',
    (DB.load('eod', {lastReportText:""}).lastReportText || '(none)')
  ].join('\n');
  reportText.textContent = rpt;
}
exportBtn.addEventListener('click', ()=>{ const blob = new Blob([ JSON.stringify({ pallets:DB.load('pallets',[]), audits:DB.load('audits',[]), staff:DB.load('staff',[]), backstock:DB.load('backstock',[]), shift:DB.load('shift',{}), eod:DB.load('eod',{}) }, null, 2) ], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='backroom-data.json'; a.click(); URL.revokeObjectURL(url); });
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', ()=>{
  const f = importFile.files[0]; if(!f) return;
  const rd = new FileReader();
  rd.onload = ()=>{ try{
    const obj = JSON.parse(rd.result);
    if(obj.pallets) DB.save('pallets', obj.pallets);
    if(obj.audits) DB.save('audits', obj.audits);
    if(obj.staff) DB.save('staff', obj.staff);
    if(obj.backstock) DB.save('backstock', obj.backstock);
    if(obj.shift) DB.save('shift', obj.shift);
    if(obj.eod) DB.save('eod', obj.eod);
    pallets = DB.load('pallets', []); staff = DB.load('staff', []); audits = DB.load('audits', []); backstock = DB.load('backstock', []); shift = DB.load('shift', shift); eod = DB.load('eod', eod);
    renderPallets(); renderStaff(); renderAudit(); renderBackstock(); paintShiftBadge(); renderReport();
  }catch(e){ alert('Invalid file.'); } };
  rd.readAsText(f);
});

/*************** Controls wiring ***************/
document.getElementById('filterRole').addEventListener('change', renderStaff);
document.getElementById('filterSub').addEventListener('change', renderStaff);
document.getElementById('compactToggle').addEventListener('change', (e)=>{ document.body.classList.toggle('compact', e.target.checked); });
document.getElementById('addEmp').addEventListener('click', ()=>{ setStaffCount(staff.length+1); document.getElementById('empCount').value = staff.length; });
document.getElementById('removeEmp').addEventListener('click', ()=>{ setStaffCount(staff.length-1); document.getElementById('empCount').value = staff.length; });
document.getElementById('empCount').addEventListener('change', (e)=>{ setStaffCount(parseInt(e.target.value||'1',10)); e.target.value = staff.length; });
document.getElementById('applyPreset').addEventListener('click', ()=>{ const name = document.getElementById('presetSelect').value;
  const idx = staff.findIndex(s=>s.name.startsWith('Employee '));
  if(idx>=0){ staff[idx].name = name; } else { staff.push({ name, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false, overdueSince:null, role:'Unloading', sub:'' }); }
  DB.save('staff', staff); setStaffCount(Math.min(10, staff.length)); renderStaff();
});
document.getElementById('notifBtn').addEventListener('click', async ()=>{ try{ await Notification.requestPermission(); alert('Notification permission: '+Notification.permission); }catch{ alert('Notifications not available.'); }});
document.getElementById('muteToggle').checked = DB.load('mute', false) ? true : false;
document.getElementById('muteToggle').addEventListener('change', (e)=>{ DB.save('mute', e.target.checked); if(!e.target.checked) AudioBus.resume(); });
document.getElementById('volSlider').value = Number(DB.load('vol','0.8'));
document.getElementById('volSlider').addEventListener('input', (e)=> AudioBus.setVolume(Number(e.target.value)));
document.getElementById('testBreak').addEventListener('click', ()=>{ AudioBus.resume(); AudioBus.chimeBreak(false); });
document.getElementById('testPallet').addEventListener('click', ()=>{ AudioBus.resume(); AudioBus.chimePallet(false); });

/*************** Boot ***************/
function boot(){
  // Pallets
  if(pallets.length===0){ pallets = Array.from({length:3}, (_,i)=> ({...structuredClone(palletDefaults), type: palletTypes[i%3]})); DB.save('pallets', pallets); }
  renderPallets();
  // Staff
  if(staff.length===0){ staff = Array.from({length:6}, (_,i)=> ({ name:`Employee ${i+1}`, status:'Working', breakElapsed:0, lunchElapsed:0, overdue:false, overdueSince:null, role:'Unloading', sub:'' })); DB.save('staff', staff); }
  document.getElementById('empCount').value = staff.length;
  renderStaff();
  // Audit
  initAuditSelectors(); renderAudit();
  // Backstock
  renderBackstock();
  // Shift badge
  paintShiftBadge();
}
boot();
</script>
</body>
</html>
